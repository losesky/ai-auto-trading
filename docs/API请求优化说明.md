# API 请求频率优化说明

## 问题描述

系统在使用币安交易所时，由于频繁调用API（如 `getPositions`、`getFuturesAccount`、`getFuturesTicker` 等），触发了币安的速率限制：

- 错误代码：-1003
- 限制：每分钟6000次请求
- 后果：IP被临时封禁

## 优化方案

### 1. 数据缓存机制

为高频访问的数据添加缓存，减少实际API调用：

#### 币安交易所 (BinanceExchangeClient)

- **持仓数据缓存**：3秒有效期
- **账户信息缓存**：5秒有效期  
- **行情数据缓存**：2秒有效期
- **K线数据缓存**：30秒有效期

#### Gate.io 交易所 (GateExchangeClient)

- **持仓数据缓存**：3秒有效期
- **账户信息缓存**：5秒有效期
- **行情数据缓存**：2秒有效期
- **K线数据缓存**：30秒有效期

### 2. 请求限流机制（仅币安）

- 最大请求频率：5500次/分钟（币安限制6000，保留安全边界）
- 最小请求间隔：100ms
- 自动等待机制：达到限制时自动延迟

### 3. 缓存失效策略

在执行会改变状态的操作后自动清除相关缓存：

- 下单成功后：清除持仓和账户缓存
- 取消订单后：清除持仓和账户缓存
- 确保数据一致性

## 实现细节

### 缓存数据结构

```typescript
{
  data: T,           // 缓存的数据
  timestamp: number  // 缓存时间戳
}
```

### 限流算法（币安）

1. 记录最近1分钟内的所有请求时间戳
2. 每次请求前检查1分钟内请求数是否超限
3. 如超限，计算需要等待的时间并延迟
4. 确保每次请求间隔至少100ms

## 性能提升

### 预期效果

- **API调用减少**：70-80%（基于缓存命中率）
- **响应速度提升**：缓存命中时接近0延迟
- **避免封禁**：请求频率始终低于限制

### 适用场景

- 健康检查服务：每5分钟检查一次，大量使用缓存
- 条件单监控：高频检查持仓状态，缓存显著减少请求
- 交易循环：多次查询同一数据，缓存提高效率

## 兼容性

### 两个交易所统一优化

- 币安和Gate.io都实现了相同的缓存策略
- 接口保持不变，业务代码无需修改
- 自动适配不同交易所的特性

### 向后兼容

- 所有接口签名保持不变
- 缓存机制对调用方透明
- 不影响现有功能

## 注意事项

1. **缓存时效**：根据数据变化频率设置不同的TTL
2. **数据一致性**：状态变更操作后立即清除缓存
3. **监控告警**：保留原有的频率限制告警机制
4. **测试验证**：建议在测试网充分验证后部署到正式网

## 监控建议

在生产环境建议监控：

- 缓存命中率
- API调用频率
- 请求延迟分布
- 限流触发次数
