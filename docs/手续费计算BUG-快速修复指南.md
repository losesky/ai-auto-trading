# æ‰‹ç»­è´¹è®¡ç®—BUG - å¿«é€Ÿä¿®å¤æŒ‡å—

## ğŸš¨ ç´§æ€¥ç¨‹åº¦ï¼šé«˜

**é—®é¢˜**ï¼šæ‰‹ç»­è´¹è¢«é«˜ä¼°çº¦1000å€ï¼ˆä¾‹å¦‚ï¼š7.2 USDT è¢«è®°å½•ä¸º 7186 USDTï¼‰

**å½±å“**ï¼šä»…å½±å“æ•°æ®åº“è®°å½•å’Œæ˜¾ç¤ºï¼Œä¸å½±å“äº¤æ˜“æ‰€å®é™…äº¤æ˜“

## å¿«é€Ÿä¿®å¤æ­¥éª¤

### 1. ç«‹å³åœæ­¢äº¤æ˜“ç³»ç»Ÿï¼ˆå¯é€‰ï¼‰

å¦‚æœæ‹…å¿ƒæ•°æ®ç»§ç»­é”™è¯¯è®°å½•ï¼Œå¯ä»¥å…ˆåœæ­¢ï¼š

```bash
pm2 stop ai-auto-trading
```

### 2. æ›´æ–°ä»£ç 

ä»£ç å·²ç»ä¿®å¤ï¼Œç›´æ¥é‡å¯å³å¯åº”ç”¨ä¿®å¤ï¼š

```bash
pm2 restart ai-auto-trading
```

### 3. ä¿®å¤å†å²æ•°æ®

è¿è¡Œä¿®å¤è„šæœ¬ï¼Œæ›´æ–°æ•°æ®åº“ä¸­çš„é”™è¯¯è®°å½•ï¼š

```bash
npx tsx --env-file=.env ./scripts/fix-pnl-calculations.ts
```

### 4. éªŒè¯ä¿®å¤ç»“æœ

æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€ï¼š

```bash
scripts/db-status.sh
```

æ£€æŸ¥æœ€è¿‘çš„äº¤æ˜“è®°å½•ï¼Œæ‰‹ç»­è´¹åº”è¯¥åœ¨åˆç†èŒƒå›´å†…ï¼ˆé€šå¸¸å°äº100 USDTï¼‰ã€‚

## é¢„æœŸä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰

```
BTCå¼€ä»“ 160å¼  @ 89826.6
âŒ æ‰‹ç»­è´¹: 7186.13 USDT

BTCå¹³ä»“ 106å¼  @ 89841.3  
âŒ æ‰‹ç»­è´¹: 11947.72 USDT
âŒ ç›ˆäº: -11947.73 USDT
```

### ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰

```
BTCå¼€ä»“ 160å¼  @ 89826.6
âœ… æ‰‹ç»­è´¹: ~7.2 USDT

BTCå¹³ä»“ 106å¼  @ 89841.3
âœ… æ‰‹ç»­è´¹: ~12 USDT  
âœ… ç›ˆäº: ~-0.01 USDT
```

## å¸¸è§é—®é¢˜

### Q: è¿™ä¸ªbugä¼šå¯¼è‡´å®é™…äºæŸå—ï¼Ÿ

**A**: ä¸ä¼šã€‚äº¤æ˜“æ‰€æ”¶å–çš„å®é™…æ‰‹ç»­è´¹æ˜¯æ­£ç¡®çš„ï¼Œåªæ˜¯æˆ‘ä»¬æ•°æ®åº“è®°å½•é”™äº†ã€‚

### Q: éœ€è¦é‡æ–°å……å€¼æˆ–æç°å—ï¼Ÿ

**A**: ä¸éœ€è¦ã€‚è´¦æˆ·ä½™é¢æ˜¯å‡†ç¡®çš„ï¼Œåªæ˜¯è®°å½•æ˜¾ç¤ºæœ‰è¯¯ã€‚

### Q: ä¿®å¤åéœ€è¦é‡æ–°è°ƒæ•´ç­–ç•¥å—ï¼Ÿ

**A**: ä¸éœ€è¦ã€‚ç­–ç•¥é€»è¾‘æ­£å¸¸ï¼Œåªæ˜¯ç›ˆäºç»Ÿè®¡ä¼šæ›´å‡†ç¡®ã€‚

### Q: å†å²æ•°æ®ä¼šè‡ªåŠ¨ä¿®å¤å—ï¼Ÿ

**A**: éœ€è¦æ‰‹åŠ¨è¿è¡Œä¿®å¤è„šæœ¬ï¼ˆæ­¥éª¤3ï¼‰ã€‚

## æŠ€æœ¯ç»†èŠ‚

**é—®é¢˜ä»£ç **ï¼š
```typescript
// âŒ é”™è¯¯
const actualQuantity = quantoMultiplier > 1 ? quantity * quantoMultiplier : quantity;
```

**ä¿®å¤ä»£ç **ï¼š
```typescript
// âœ… æ­£ç¡®
const notionalValue = quantity * quantoMultiplier * price;
```

**å½±å“æ–‡ä»¶**ï¼š
- `src/scheduler/priceOrderMonitor.ts`
- `src/tools/trading/tradeExecution.ts`
- `src/tools/trading/takeProfitManagement.ts`
- `scripts/fix-pnl-calculations.ts`

## å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] ä»£ç å·²æ›´æ–°ï¼ˆpm2 restartï¼‰
- [ ] ä¿®å¤è„šæœ¬å·²è¿è¡Œ
- [ ] æ•°æ®åº“çŠ¶æ€å·²éªŒè¯ï¼ˆæ‰‹ç»­è´¹åˆç†ï¼‰
- [ ] ç³»ç»Ÿæ­£å¸¸è¿è¡Œ

---

å¦‚æœ‰ç–‘é—®ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š`docs/æ‰‹ç»­è´¹è®¡ç®—BUGä¿®å¤æ€»ç»“.md`
