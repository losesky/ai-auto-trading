# 回测系统 - 快速参考指南

> 📖 这是回测系统的精简版参考指南。完整方案请查看 [回测系统构建方案-TODO.md](./回测系统构建方案-TODO.md)

## 🎯 快速理解

### 为什么需要回测系统？

- ⏰ **时间问题**：测试网验证需要数周/数月，回测只需几分钟
- 💡 **快速试错**：快速排除明显无效的想法
- 📊 **量化评估**：用数据说话，避免主观判断
- 🎲 **压力测试**：测试极端市场情况（牛市/熊市/暴跌）

### 核心设计理念

```markdown
真实交易系统                    回测系统
     ↓                            ↓
┌─────────┐                 ┌─────────┐
│ AI Agent│                 │规则引擎 │  ← 模拟AI决策（85%准确度）
└────┬────┘                 └────┬────┘
     │                            │
┌────┴────┐                 ┌────┴────┐
│ Gate API│                 │ Mock API│  ← 模拟交易所
└────┬────┘                 └────┬────┘
     │                            │
  真实市场                    历史数据
```

**关键创新**：

- ✅ **规则引擎模拟AI**：成本$0，速度0.5ms/决策（vs AI的$0.01和5秒）
- ✅ **高准确度**：85-90%复现AI决策逻辑（通过深度分析提示词）
- ✅ **三种模式**：纯规则（日常）/ 混合（验证）/ 纯AI（研究）
- ✅ **完全可复现**：相同输入保证相同输出

**为什么不用真实AI？**

- ❌ **成本高**：1年回测(35000次调用) × $0.01 = $350
- ❌ **速度慢**：5秒/决策 × 35000 = 48小时
- ❌ **不可复现**：AI有随机性，无法做A/B测试
- ❌ **无法批量**：参数优化需要数百次回测，成本爆炸

---

## 📋 系统组成（7 个核心模块）

### 1. 历史数据层

- **下载器**：从 Gate.io/Binance 下载 K线数据
- **缓存**：本地存储，支持增量更新
- **验证器**：检测数据缺失/异常

### 2. 模拟交易所

- **订单撮合**：模拟市价单/限价单/条件单
- **滑点计算**：基于流动性的真实滑点
- **手续费**：Maker/Taker 费率

### 3. 时间模拟器

- **逐 Bar 回放**：按 5分钟/15分钟/1小时推进
- **事件驱动**：K线更新 → AI决策 → 订单执行

### 4. 回测引擎

- **主循环**：协调各模块
- **Agent 调用**：使用真实的 AI Agent
- **状态管理**：账户/持仓/订单

### 5. 绩效追踪

- **实时记录**：资金曲线/交易明细/持仓变化
- **指标计算**：夏普比率/最大回撤/胜率/R倍数

### 6. 报告生成

- **HTML 报告**：图表可视化
- **Markdown 报告**：便于保存
- **JSON 导出**：用于二次分析

### 7. CLI 工具

- **回测命令**：一键运行回测
- **对比工具**：多策略对比
- **参数优化**：网格搜索最优参数

---

## 🚀 快速开始（3 步）

### Step 1: 下载历史数据

```bash
npm run backtest:download-data -- \
  --symbols BTC,ETH,SOL \
  --start 2024-01-01 \
  --end 2024-12-31 \
  --exchange gate
```

**预计时间**：10-20 分钟（取决于网络）  
**存储空间**：~150MB（3个币种，1年数据）

### Step 2: 运行回测

```bash
npm run backtest -- \
  --preset standard \
  --symbols BTC,ETH \
  --start 2024-01-01 \
  --end 2024-12-31
```

**预计时间**：5-10 分钟  
**输出**：`./backtest-results/run-001/`

### Step 3: 查看报告

```bash
# 在浏览器打开
open ./backtest-results/run-001/report.html
```

---

## 📊 典型工作流

### 场景 1: 验证新策略想法

```bash
# 1. 快速回测（粗略验证）
npm run backtest -- --preset fast --symbols BTC --start 2024-01-01 --end 2024-03-31

# 2. 如果有希望，完整回测
npm run backtest -- --preset standard --symbols BTC,ETH,SOL --start 2024-01-01 --end 2024-12-31

# 3. 如果表现好，上测试网验证
npm run trading:start  # 测试网环境
```

### 场景 2: 优化策略参数

```bash
# 测试不同杠杆的表现
npm run backtest:optimize -- \
  --parameter max_leverage \
  --range 5-20 \
  --step 5 \
  --symbols BTC \
  --start 2024-01-01 \
  --end 2024-12-31

# 输出：max_leverage 对收益率的影响热力图
```

### 场景 3: 对比多个策略

```bash
npm run backtest:compare -- \
  --strategies balanced,aggressive,conservative \
  --symbols BTC,ETH \
  --start 2024-01-01 \
  --end 2024-12-31

# 输出：三个策略的对比报告
```

---

## 🎯 关键指标解读

### 收益指标

| 指标 | 说明 | 好坏标准 |
|------|------|---------|
| 总收益率 | 整个回测期间的收益 | > 30% 优秀 |
| 年化收益率 | 按年计算的收益 | > 50% 优秀 |
| 月均收益 | 平均每月收益 | > 5% 优秀 |

### 风险指标

| 指标 | 说明 | 好坏标准 |
|------|------|---------|
| 夏普比率 | 风险调整后收益 | > 1.5 优秀 |
| 最大回撤 | 资金曲线最大跌幅 | < 20% 优秀 |
| 回撤持续时间 | 从高点到恢复的时间 | < 30天 优秀 |

### 交易指标

| 指标 | 说明 | 好坏标准 |
|------|------|---------|
| 胜率 | 盈利交易占比 | > 55% 优秀 |
| 盈利因子 | 总盈利/总亏损 | > 2.0 优秀 |
| 平均 R 倍数 | 平均盈利/平均止损 | > 1.5R 优秀 |

### 如何判断策略质量？

**优秀策略**（可以上测试网）：

- ✅ 夏普比率 > 1.5
- ✅ 最大回撤 < 20%
- ✅ 胜率 > 55%
- ✅ 盈利因子 > 2.0
- ✅ 交易次数适中（不过度交易）

**需要改进**（继续优化）：

- ⚠️ 夏普比率 < 1.0
- ⚠️ 最大回撤 > 30%
- ⚠️ 胜率 < 50%
- ⚠️ 盈利因子 < 1.5

**直接放弃**（明显无效）：

- ❌ 总收益为负
- ❌ 盈利因子 < 1.0
- ❌ 最大回撤 > 50%
- ❌ 连续亏损 > 10 笔

---

## ⚠️ 常见陷阱

### 1. 过拟合（Overfitting）

**表现**：回测完美，实盘爆亏

**原因**：

- 参数过度优化（专门针对历史数据调参）
- 使用了未来数据（前视偏差）
- 忽略了交易成本（滑点/手续费）

**预防**：

- ✅ 使用样本外测试（训练集 + 验证集）
- ✅ 保持参数简单（少于 5 个可调参数）
- ✅ Walk-Forward 分析（滚动验证）

### 2. 数据偏差（Survivorship Bias）

**表现**：只测试现存币种，忽略已下架币种

**预防**：

- ✅ 包含历史上已下架的合约
- ✅ 模拟合约下架场景
- ✅ 测试在熊市的表现

### 3. 滑点过于乐观

**表现**：回测假设零滑点，实盘滑点严重

**预防**：

- ✅ 使用保守的滑点估算（至少 0.02%）
- ✅ 模拟大单的价格冲击
- ✅ 考虑流动性不足的时段

### 4. 忽略极端市场

**表现**：在正常市场表现好,暴涨暴跌时爆仓

**预防**：

- ✅ 测试包含 2021 牛市、2022 熊市的完整周期
- ✅ 专门测试暴跌日（如 FTX 事件）
- ✅ 检查最大杠杆是否合理

---

## 🛠️ 配置参考

### 回测精度模式

```typescript
// 快速模式（粗略验证）
{
  precision: 'fast',
  slippageModel: 'optimistic',
  enableOrderBookSimulation: false,
  // 预计速度：3x 实时（1年 → 5分钟）
}

// 标准模式（日常使用）
{
  precision: 'standard',
  slippageModel: 'standard',
  enableOrderBookSimulation: false,
  // 预计速度：1x 实时（1年 → 10分钟）
}

// 精确模式（最终验证）
{
  precision: 'accurate',
  slippageModel: 'conservative',
  enableOrderBookSimulation: true,  // 使用订单簿数据
  // 预计速度：0.5x 实时（1年 → 20分钟）
}
```

### 推荐回测周期

| 策略类型 | 最短周期 | 推荐周期 | 原因 |
|---------|---------|---------|------|
| 超短线 | 1个月 | 3个月 | 交易频繁，样本量足够 |
| 波段 | 3个月 | 6个月 | 需要多个完整波段 |
| 趋势 | 6个月 | 1年 | 需要牛熊市完整周期 |

### 样本量要求

**最少交易次数**：

- 超短线：> 100 笔
- 波段：> 50 笔
- 趋势：> 30 笔

**原因**：样本量太小，统计意义不足（可能是运气）

---

## 📈 进阶用法

### Walk-Forward 分析（避免过拟合）

```bash
# 滚动窗口验证
npm run backtest:walk-forward -- \
  --train-period 6months \
  --test-period 1month \
  --total-period 2years \
  --symbols BTC,ETH
```

**输出**：

- 每个测试窗口的表现
- 平均测试集收益率（更可靠）
- 策略退化检测

### 蒙特卡罗模拟（评估稳健性）

```bash
# 1000次随机模拟
npm run backtest:monte-carlo -- \
  --iterations 1000 \
  --symbols BTC \
  --start 2024-01-01 \
  --end 2024-12-31
```

**输出**：

- 收益率分布（5% / 50% / 95% 分位数）
- 最差情况收益率
- 策略稳健性评分

### 实盘对比验证

```bash
# 使用相同时间段对比
npm run backtest:validate -- \
  --live-result ./live-trading-2024Q1.json \
  --symbols BTC,ETH \
  --start 2024-01-01 \
  --end 2024-03-31
```

**输出**：

- 回测 vs 实盘收益率差异
- 交易次数差异
- 差异原因分析

---

## 🎯 实施优先级

### Phase 1: MVP（2周）

**目标**：能跑起来，验证想法

- [ ] 历史数据下载器
- [ ] 简单的模拟交易所（市价单）
- [ ] 基础回测引擎（逐 Bar）
- [ ] 简单报告（Markdown）

**验收**：能完成一次简单回测，生成基础报告

### Phase 2: 完善（2周）

**目标**：贴合真实，减少偏差

- [ ] 滑点/手续费模拟
- [ ] 条件单支持（止损/止盈）
- [ ] HTML 报告（图表）
- [ ] CLI 工具

**验收**：回测结果与测试网基本一致（误差 < 20%）

### Phase 3: 高级（可选）

**目标**：深入分析，持续优化

- [ ] Walk-Forward 分析
- [ ] 蒙特卡罗模拟
- [ ] 参数优化工具
- [ ] 实盘对比

---

## 📞 下一步行动

1. **审阅方案**：Review [回测系统构建方案-TODO.md](./回测系统构建方案-TODO.md)
2. **提出修改意见**：有不合理的地方及时指出
3. **确定优先级**：确认 Phase 1-3 的实施顺序
4. **开始编码**：从 Phase 1.1（数据层）开始

---

## 📚 相关文档

- [完整方案](./回测系统构建方案-TODO.md) - 详细的技术方案和实施计划
- [架构设计图](./回测系统构建方案-TODO.md#系统架构设计) - 系统架构图
- [数据需求](./回测系统构建方案-TODO.md#数据需求分析) - 数据存储需求

---

**最后更新**：2025-11-13  
**版本**：v1.0  
**作者**：AI Assistant
