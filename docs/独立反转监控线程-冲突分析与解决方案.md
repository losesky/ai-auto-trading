# ç‹¬ç«‹åè½¬ç›‘æ§çº¿ç¨‹ - å†²çªåˆ†æä¸è§£å†³æ–¹æ¡ˆ

## ğŸ“Š æ½œåœ¨å†²çªç‚¹åˆ†æ

### 1. å¹¶å‘å¹³ä»“å†²çª âš ï¸âš ï¸âš ï¸ ï¼ˆæœ€ä¸¥é‡ï¼‰

**å†²çªåœºæ™¯**:

```markdown
æ—¶é—´ç‚¹ T0:
  - åè½¬ç›‘æ§çº¿ç¨‹ï¼ˆ3åˆ†é’Ÿå‘¨æœŸï¼‰: æ£€æµ‹åˆ° reversalScore=50ï¼Œè§¦å‘ç´§æ€¥å¹³ä»“
  - å¼€å§‹è°ƒç”¨ exchange.closePosition('BTC', ...)

æ—¶é—´ç‚¹ T0+5ç§’:
  - ä¸»äº¤æ˜“çº¿ç¨‹ï¼ˆ15åˆ†é’Ÿå‘¨æœŸï¼‰: åŒæ—¶æ£€æµ‹åˆ° reversalScore=60ï¼Œä¹Ÿè§¦å‘å¹³ä»“
  - å¼€å§‹è°ƒç”¨ closePosition('BTC', 'trend_reversal')

ç»“æœ:
  âŒ ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å°è¯•å¹³ä»“åŒä¸€ä¸ªæŒä»“
  âŒ å¯èƒ½å¯¼è‡´é‡å¤APIè°ƒç”¨ã€æ•°æ®åº“å†²çªã€èµ„é‡‘è®¡ç®—é”™è¯¯
```

**å½±å“**:

- ä¸¥é‡æ€§: â­â­â­â­â­
- å‘ç”Ÿæ¦‚ç‡: é«˜ï¼ˆåè½¬ä¿¡å·ä»30åˆ†â†’50åˆ†â†’60åˆ†å¯èƒ½åœ¨å‡ åˆ†é’Ÿå†…å‘ç”Ÿï¼‰
- åæœ: ç³»ç»Ÿé”™è¯¯ã€äº¤æ˜“å¤±è´¥ã€èµ„é‡‘è®¡ç®—å¼‚å¸¸

---

### 2. æ•°æ®åº“å†™å…¥ç«äº‰ âš ï¸âš ï¸ ï¼ˆä¸­ç­‰ä¸¥é‡ï¼‰

**å†²çªåœºæ™¯**:

```markdown
åè½¬ç›‘æ§çº¿ç¨‹:
  - å†™å…¥ agent_decisions (reversal_early_warning)
  - æ›´æ–° positions.metadata (reversalWarningæ ‡è®°)
  - å†™å…¥ position_close_events (ç´§æ€¥å¹³ä»“)

ä¸»äº¤æ˜“çº¿ç¨‹:
  - è¯»å– positions è¡¨
  - æ›´æ–° positions è¡¨ï¼ˆç§»åŠ¨æ­¢æŸã€åˆ†æ‰¹æ­¢ç›ˆï¼‰
  - å†™å…¥ agent_decisions (AIå†³ç­–)

ç»“æœ:
  âŒ æ•°æ®åº“é”ç«äº‰
  âŒ metadataå­—æ®µè¢«è¦†ç›–ï¼ˆä¸¢å¤±é¢„è­¦æ ‡è®°ï¼‰
  âŒ agent_decisionsè¡¨å¯èƒ½è®°å½•ä¸ä¸€è‡´
```

**å½±å“**:

- ä¸¥é‡æ€§: â­â­â­
- å‘ç”Ÿæ¦‚ç‡: ä¸­ï¼ˆä¸¤ä¸ªçº¿ç¨‹å‘¨æœŸä¸åŒï¼Œä½†ä»æœ‰é‡å å¯èƒ½ï¼‰
- åæœ: æ•°æ®ä¸ä¸€è‡´ã€æ—¥å¿—æ··ä¹±ã€éš¾ä»¥å›æº¯å†³ç­–

---

### 3. AIå†³ç­–æ··æ·† âš ï¸ ï¼ˆè½»åº¦ï¼‰

**å†²çªåœºæ™¯**:

å½“å‰tradingAgent.tsçš„AIå†³ç­–æµç¨‹:

```typescript
æ­¥éª¤1: æ£€æŸ¥ reversalScore â‰¥ 60 â†’ ç«‹å³å¹³ä»“
æ­¥éª¤2: æ£€æŸ¥åˆ†æ‰¹æ­¢ç›ˆæœºä¼š
æ­¥éª¤3: æ£€æŸ¥ reversalScore 40-60 â†’ å»ºè®®å¹³ä»“
```

åè½¬ç›‘æ§çº¿ç¨‹çš„é€»è¾‘:

```typescript
if (reversalScore >= 50 && pnlPercent < 2):
  â†’ ç«‹å³å¹³ä»“
if (reversalScore >= 40):
  â†’ æ ‡è®° metadata.reversalWarning
```

**é—®é¢˜**:

- ä¸»çº¿ç¨‹å’Œç›‘æ§çº¿ç¨‹çš„é˜ˆå€¼ä¸ä¸€è‡´ï¼ˆ60 vs 50ï¼‰
- AIå¯èƒ½å›°æƒ‘ï¼š"ä¸ºä»€ä¹ˆæŒä»“çªç„¶æ¶ˆå¤±äº†ï¼Ÿæˆ‘è¿˜æ²¡å†³ç­–å®Œ"
- AIæç¤ºè¯ä¸­è¯´"reversalScore â‰¥ 60æ‰å¹³ä»“"ï¼Œä½†å®é™…50åˆ†å°±è¢«å¹³äº†

**å½±å“**:

- ä¸¥é‡æ€§: â­â­
- å‘ç”Ÿæ¦‚ç‡: é«˜
- åæœ: AIå†³ç­–é€»è¾‘æ··ä¹±ã€æ— æ³•å¤ç°ã€æ—¥å¿—éš¾ä»¥ç†è§£

---

### 4. é˜ˆå€¼ä¸ä¸€è‡´ âš ï¸

**å½“å‰é…ç½®å¯¹æ¯”**:

| çº¿ç¨‹ | å¼±ä¿¡å·é¢„è­¦ | ä¸­ç­‰ä¿¡å· | å¼ºä¿¡å·å¹³ä»“ |
|-----|-----------|---------|-----------|
| **åè½¬ç›‘æ§çº¿ç¨‹** | â‰¥30åˆ† | â‰¥40åˆ†ï¼ˆæ ‡è®°ï¼‰ | â‰¥50åˆ†ï¼ˆå¹³ä»“ï¼‰ |
| **ä¸»äº¤æ˜“çº¿ç¨‹ï¼ˆAIï¼‰** | æ— æ˜ç¡®å®šä¹‰ | â‰¥40åˆ†ï¼ˆå»ºè®®ï¼‰ | â‰¥60åˆ†ï¼ˆå¼ºåˆ¶ï¼‰ |

**é—®é¢˜**:

- åè½¬ç›‘æ§çº¿ç¨‹åœ¨50åˆ†å°±å¹³ä»“ï¼Œä½†AIè®¤ä¸ºè¦60åˆ†æ‰å¹³
- AIçš„40-60åˆ†"å»ºè®®å¹³ä»“"é€»è¾‘è¢«åè½¬ç›‘æ§çº¿ç¨‹æŠ¢å…ˆæ‰§è¡Œ
- ä¸¤ä¸ªç³»ç»Ÿçš„å†³ç­–è¾¹ç•Œä¸æ¸…æ™°

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆA: ç»Ÿä¸€æ‰§è¡Œå™¨ + åˆ†å¸ƒå¼é”ï¼ˆæ¨èï¼‰â­â­â­â­â­

**æ ¸å¿ƒæ€æƒ³**ï¼šå‚è€ƒ `healthCheck.ts` ä¸­çš„"åˆ†æ‰¹æ­¢ç›ˆè‡ªåŠ¨æ‰§è¡Œ"æœºåˆ¶ï¼Œå°†åè½¬ç›‘æ§ä¹Ÿå®ç°ä¸ºç»Ÿä¸€çš„æ‰§è¡Œå™¨æ¨¡å¼ã€‚

#### å…³é”®è®¾è®¡å‚è€ƒ

ä» `src/services/partialTakeProfitExecutor.ts` å­¦ä¹ åˆ°çš„æœ€ä½³å®è·µï¼š

1. **åˆ†å¸ƒå¼é”**: ä½¿ç”¨ `system_config` è¡¨å­˜å‚¨é”çŠ¶æ€ï¼Œé¿å… `metadata` å­—æ®µå†²çª
   - é”çš„é”®æ ¼å¼: `partial_tp_{symbol}_{side}_stage{N}` æˆ– `reversal_close_{symbol}_{side}`
   - é”è¶…æ—¶æ—¶é—´: 30ç§’ï¼ˆé˜²æ­¢æ­»é”ï¼‰
   - é”æŒæœ‰è€…æ ‡è¯†: `health-check`, `ai-agent`, `reversal-monitor`

2. **å»é‡æœºåˆ¶**: æ£€æŸ¥æœ€è¿‘æ‰§è¡Œè®°å½•ï¼Œé˜²æ­¢30ç§’å†…é‡å¤è§¦å‘
   - åˆ†æ‰¹æ­¢ç›ˆ: æ£€æŸ¥ `partial_take_profit_history` è¡¨çš„æœ€è¿‘30ç§’è®°å½•
   - åè½¬å¹³ä»“: æ£€æŸ¥ `position_close_events` è¡¨çš„æœ€è¿‘30ç§’è®°å½•

3. **è°ƒç”¨è€…æ ‡è¯†**: æ˜ç¡®æ ‡è¯†æ˜¯è°è§¦å‘çš„
   - `health-check`: å¥åº·æ£€æŸ¥å…œåº•ä¿æŠ¤
   - `ai-agent`: ä¸»äº¤æ˜“AIå†³ç­–
   - `reversal-monitor`: ç‹¬ç«‹åè½¬ç›‘æ§çº¿ç¨‹

4. **ç»Ÿä¸€å…¥å£**: æ‰€æœ‰è°ƒç”¨è€…éƒ½é€šè¿‡åŒä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œé¿å…å¹¶å‘å†²çª
   - å¥åº·æ£€æŸ¥æ¯60ç§’è°ƒç”¨ `PartialTakeProfitExecutor.executeCheck('health-check')`
   - åè½¬ç›‘æ§æ¯3åˆ†é’Ÿè°ƒç”¨ `ReversalMonitorExecutor.executeCheck('reversal-monitor')`
   - AI Agentå¯é€‰åœ°åœ¨å†³ç­–å‰è°ƒç”¨æ‰§è¡Œå™¨

5. **åˆ†å¸ƒå¼é”å·¥ä½œæµç¨‹**ï¼ˆå…³é”®é˜²å†²çªæœºåˆ¶ï¼‰:

```typescript
// ä¼ªä»£ç ç¤ºä¾‹ï¼ˆæ¥è‡ª partialTakeProfitExecutor.tsï¼‰
async function executePartialTP(symbol, stage) {
  const lockKey = `partial_tp_${symbol}_stage${stage}`;
  const caller = 'health-check'; // æˆ– 'ai-agent'
  
  // æ­¥éª¤1: æ£€æŸ¥æœ€è¿‘æ˜¯å¦å·²æ‰§è¡Œï¼ˆæ•°æ®åº“çº§å»é‡ï¼‰
  const hasRecent = await hasRecentExecution(symbol, stage, 30);
  if (hasRecent) {
    return { result: 'recently_executed', skipped: true };
  }
  
  // æ­¥éª¤2: å°è¯•è·å–åˆ†å¸ƒå¼é”
  const lockAcquired = await DistributedLock.tryAcquire(lockKey, caller);
  if (!lockAcquired) {
    // é”è¢«å…¶ä»–çº¿ç¨‹/æœåŠ¡æŒæœ‰ï¼Œè·³è¿‡
    return { result: 'lock_busy', skipped: true };
  }
  
  try {
    // æ­¥éª¤3: å†æ¬¡ç¡®è®¤æ˜¯å¦å·²æ‰§è¡Œï¼ˆåŒé‡æ£€æŸ¥ï¼‰
    const alreadyDone = await checkHistoryTable(symbol, stage);
    if (alreadyDone) {
      return { result: 'already_executed', skipped: true };
    }
    
    // æ­¥éª¤4: æ‰§è¡Œå®é™…æ“ä½œï¼ˆè°ƒç”¨APIï¼‰
    await partialTakeProfitTool.execute({ symbol, stage });
    
    // æ­¥éª¤5: è®°å½•æ‰§è¡Œå†å²
    await insertHistory(symbol, stage, 'completed');
    
    return { result: 'success', executed: true };
    
  } finally {
    // æ­¥éª¤6: å¿…é¡»é‡Šæ”¾é”ï¼ˆå³ä½¿å‘ç”Ÿå¼‚å¸¸ï¼‰
    await DistributedLock.release(lockKey, caller);
  }
}
```

6. **åˆ†å¸ƒå¼é”çš„æ•°æ®åº“å®ç°**ï¼ˆæ— éœ€Redis/ZooKeeperï¼‰:

```sql
-- system_config è¡¨ç»“æ„ï¼ˆå·²å­˜åœ¨ï¼‰
CREATE TABLE system_config (
  key TEXT PRIMARY KEY,
  value TEXT,
  updated_at TEXT
);

-- è·å–é”ï¼ˆINSERT OR REPLACEï¼‰
INSERT OR REPLACE INTO system_config (key, value, updated_at)
VALUES ('partial_tp_BTC_stage1', 'health-check', '2025-01-15T10:30:00Z');

-- æ£€æŸ¥é”çŠ¶æ€
SELECT value, updated_at FROM system_config
WHERE key = 'partial_tp_BTC_stage1';

-- é‡Šæ”¾é”ï¼ˆDELETEï¼‰
DELETE FROM system_config
WHERE key = 'partial_tp_BTC_stage1' AND value = 'health-check';
```

7. **é”å†²çªåœºæ™¯æ¼”ç¤º**:

```markdown
æ—¶é—´çº¿ï¼ˆåŒä¸€ä¸ªBTCæŒä»“çš„Stage1åˆ†æ‰¹æ­¢ç›ˆï¼‰ï¼š

T0: å¥åº·æ£€æŸ¥çº¿ç¨‹æ£€æµ‹åˆ° BTC â‰¥ 1R
  â†’ å°è¯•è·å–é” 'partial_tp_BTC_stage1'
  â†’ æˆåŠŸè·å–ï¼Œvalue='health-check', updated_at=T0
  â†’ å¼€å§‹æ‰§è¡Œ partialTakeProfitTool

T0+5s: AI Agent ä¹Ÿæ£€æµ‹åˆ° BTC â‰¥ 1R
  â†’ å°è¯•è·å–é” 'partial_tp_BTC_stage1'
  â†’ æ£€æŸ¥é”çŠ¶æ€: value='health-check', lockAge=5s < 30s
  â†’ é”è¢«å ç”¨ï¼Œè¿”å› lock_busy
  â†’ è®°å½•æ—¥å¿—: "BTC Stage1 é”è¢« health-check æŒæœ‰ï¼Œå‰©ä½™25ç§’"
  â†’ è·³è¿‡æ­¤æ¬¡æ‰§è¡Œ

T0+10s: å¥åº·æ£€æŸ¥çº¿ç¨‹æ‰§è¡Œå®Œæˆ
  â†’ é‡Šæ”¾é” DELETE FROM system_config WHERE key='...'
  â†’ è®°å½•å†å² INSERT INTO partial_take_profit_history (symbol, stage, status='completed')

T0+60s: å¥åº·æ£€æŸ¥çº¿ç¨‹ä¸‹ä¸€è½®
  â†’ æ£€æŸ¥æœ€è¿‘æ‰§è¡Œ: SELECT COUNT(*) FROM history WHERE timestamp > T0-30s
  â†’ count=1ï¼ˆåˆšæ‰æ‰§è¡Œè¿‡ï¼‰ï¼Œè¿”å› recently_executed
  â†’ è·³è¿‡æ­¤æ¬¡æ‰§è¡Œ

ç»“æœ: å®Œå…¨é¿å…é‡å¤æ‰§è¡Œï¼Œæ•°æ®åº“çº§åˆ«ä¿è¯ä¸€è‡´æ€§
```

#### å®ç°æ–¹æ¡ˆ

##### 1. æ–°å¢åè½¬ç›‘æ§æ‰§è¡Œå™¨

å®Œæ•´å‚è€ƒ `partialTakeProfitExecutor.ts` çš„å®ç°æ¨¡å¼ï¼š

```typescript
// src/services/reversalMonitorExecutor.ts

import { createClient } from "@libsql/client";
import { createLogger } from "../utils/logger";
import { getExchangeClient } from "../exchanges";
import { analyzeMarketState } from "./marketStateAnalyzer";

const logger = createLogger({
  name: "reversal-executor",
  level: "info",
});

const dbClient = createClient({
  url: process.env.DATABASE_URL || "file:./.voltagent/trading.db",
});

/**
 * åˆ†å¸ƒå¼é”ç®¡ç†å™¨ï¼ˆå®Œå…¨å¤ç”¨ PartialTakeProfitExecutor çš„è®¾è®¡ï¼‰
 */
class DistributedLock {
  private static readonly LOCK_TIMEOUT_MS = 30000; // 30ç§’é”è¶…æ—¶

  /**
   * å°è¯•è·å–é”
   * @param key é”çš„é”®ï¼ˆå¦‚ "reversal_close_BTC_long"ï¼‰
   * @param holder é”æŒæœ‰è€…æ ‡è¯†ï¼ˆå¦‚ "health-check", "reversal-monitor"ï¼‰
   * @returns true-è·å–æˆåŠŸ, false-é”è¢«å ç”¨
   */
  static async tryAcquire(key: string, holder: string): Promise<boolean> {
    try {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰é”
      const checkResult = await dbClient.execute({
        sql: 'SELECT value, updated_at FROM system_config WHERE key = ?',
        args: [key]
      });

      if (checkResult.rows.length > 0) {
        const lockValue = checkResult.rows[0].value as string;
        const lockTime = new Date(checkResult.rows[0].updated_at as string).getTime();
        const now = Date.now();
        const lockAge = now - lockTime;

        // å¦‚æœé”æœªè¿‡æœŸï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±æŒæœ‰çš„é”
        if (lockAge < this.LOCK_TIMEOUT_MS) {
          if (lockValue === holder) {
            // è‡ªå·±æŒæœ‰çš„é”ï¼Œåˆ·æ–°æ—¶é—´
            await dbClient.execute({
              sql: 'UPDATE system_config SET updated_at = ? WHERE key = ?',
              args: [new Date().toISOString(), key]
            });
            return true;
          }
          // å…¶ä»–æœåŠ¡æŒæœ‰çš„é”
          logger.debug(`é” ${key} è¢« ${lockValue} æŒæœ‰ï¼Œå‰©ä½™ ${Math.ceil((this.LOCK_TIMEOUT_MS - lockAge) / 1000)}ç§’`);
          return false;
        }

        // é”å·²è¿‡æœŸï¼Œå¯ä»¥æŠ¢å 
        logger.warn(`é” ${key} å·²è¿‡æœŸ(${lockValue})ï¼Œå¼ºåˆ¶è·å–`);
      }

      // è·å–é”
      await dbClient.execute({
        sql: 'INSERT OR REPLACE INTO system_config (key, value, updated_at) VALUES (?, ?, ?)',
        args: [key, holder, new Date().toISOString()]
      });

      logger.debug(`âœ… ${holder} è·å–é”: ${key}`);
      return true;
    } catch (error: any) {
      logger.error(`è·å–é”å¤±è´¥: ${error.message}`);
      return false;
    }
  }

  /**
   * é‡Šæ”¾é”
   */
  static async release(key: string, holder: string): Promise<void> {
    try {
      const checkResult = await dbClient.execute({
        sql: 'SELECT value FROM system_config WHERE key = ?',
        args: [key]
      });

      if (checkResult.rows.length > 0 && checkResult.rows[0].value === holder) {
        await dbClient.execute({
          sql: 'DELETE FROM system_config WHERE key = ?',
          args: [key]
        });
        logger.debug(`ğŸ”“ ${holder} é‡Šæ”¾é”: ${key}`);
      }
    } catch (error: any) {
      logger.error(`é‡Šæ”¾é”å¤±è´¥: ${error.message}`);
    }
  }

  /**
   * æ£€æŸ¥æœ€è¿‘æ˜¯å¦æœ‰å¹³ä»“è®°å½•ï¼ˆé˜²æ­¢é‡å¤å¹³ä»“ï¼‰
   * @param symbol å¸ç§
   * @param side æ–¹å‘
   * @param windowSeconds æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
   */
  static async hasRecentClose(symbol: string, side: string, windowSeconds: number = 30): Promise<boolean> {
    try {
      const cutoffTime = new Date(Date.now() - windowSeconds * 1000).toISOString();
      
      const result = await dbClient.execute({
        sql: `SELECT COUNT(*) as count FROM position_close_events 
              WHERE symbol = ? AND side = ? AND created_at > ? AND close_reason LIKE '%reversal%'`,
        args: [symbol, side, cutoffTime]
      });

      const count = Number(result.rows[0]?.count || 0);
      return count > 0;
    } catch (error: any) {
      logger.error(`æ£€æŸ¥å¹³ä»“è®°å½•å¤±è´¥: ${error.message}`);
      return false;
    }
  }
}

/**
 * åè½¬ç›‘æ§æ‰§è¡Œå™¨
 */
export class ReversalMonitorExecutor {
  /**
   * æ‰§è¡Œåè½¬ç›‘æ§æ£€æŸ¥å’Œè‡ªåŠ¨å¹³ä»“
   * @param caller è°ƒç”¨è€…æ ‡è¯†ï¼ˆå¦‚ 'health-check', 'reversal-monitor', 'ai-agent'ï¼‰
   * @returns æ‰§è¡Œç»“æœ
   */
  static async executeCheck(caller: string): Promise<{
    success: boolean;
    warned: number;
    closed: number;
    skipped: number;
    details: Array<{ 
      symbol: string; 
      side: string;
      reversalScore: number;
      action: 'warned' | 'closed' | 'skipped';
      reason: string;
    }>;
  }> {
    const details: Array<any> = [];
    let warnedCount = 0;
    let closedCount = 0;
    let skippedCount = 0;

    try {
      // è·å–æ‰€æœ‰æŒä»“
      const dbPositions = await dbClient.execute({
        sql: 'SELECT symbol, side, entry_price, current_price, unrealized_pnl, quantity, leverage FROM positions WHERE quantity != 0'
      });

      if (dbPositions.rows.length === 0) {
        return { success: true, warned: 0, closed: 0, skipped: 0, details: [] };
      }

      for (const pos of dbPositions.rows) {
        const symbol = pos.symbol as string;
        const side = pos.side as 'long' | 'short';
        const entryPrice = parseFloat(pos.entry_price as string || '0');
        let currentPrice = parseFloat(pos.current_price as string || '0');

        // è·å–æœ€æ–°ä»·æ ¼
        try {
          const exchangeClient = getExchangeClient();
          const contract = exchangeClient.normalizeContract(symbol);
          const ticker = await exchangeClient.getFuturesTicker(contract);
          currentPrice = parseFloat(ticker.last || '0');
        } catch (priceError: any) {
          logger.debug(`è·å–${symbol}ä»·æ ¼å¤±è´¥ï¼Œè·³è¿‡: ${priceError.message}`);
          continue;
        }

        if (currentPrice <= 0) continue;

        // è®¡ç®—å½“å‰ç›ˆäº
        const pnlPercent = side === 'long'
          ? ((currentPrice - entryPrice) / entryPrice) * 100
          : ((entryPrice - currentPrice) / entryPrice) * 100;

        // åˆ†æå¸‚åœºçŠ¶æ€
        let reversalScore = 0;
        try {
          const analysis = await analyzeMarketState(symbol, { direction: side });
          reversalScore = analysis.reversalAnalysis?.reversalScore || 0;
        } catch (analysisError: any) {
          logger.debug(`åˆ†æ${symbol}å¸‚åœºçŠ¶æ€å¤±è´¥: ${analysisError.message}`);
          continue;
        }

        // æ—©æœŸé¢„è­¦ï¼ˆ30-49åˆ†ï¼‰ï¼šä»…è®°å½•
        if (reversalScore >= 30 && reversalScore < 50) {
          logger.warn(`âš ï¸ [${caller}] ${symbol} æ—©æœŸåè½¬é¢„è­¦ (${reversalScore.toFixed(0)}åˆ†)`);
          
          // æ›´æ–°æŒä»“metadataï¼ˆéé”å­—æ®µï¼Œåªæ˜¯æ ‡è®°ï¼‰
          await dbClient.execute({
            sql: `UPDATE positions SET metadata = json_set(
                    COALESCE(metadata, '{}'), 
                    '$.reversalWarning', 1,
                    '$.warningScore', ?,
                    '$.warningTime', ?
                  ) WHERE symbol = ? AND side = ?`,
            args: [reversalScore, new Date().toISOString(), symbol, side]
          });

          warnedCount++;
          details.push({ 
            symbol, 
            side,
            reversalScore, 
            action: 'warned', 
            reason: 'early_warning' 
          });
          continue;
        }

        // ğŸš¨ ç´§æ€¥å¹³ä»“ï¼ˆâ‰¥50åˆ† ä¸” ç›ˆåˆ©ä¸è¶³2%ï¼‰
        if (reversalScore >= 50 && pnlPercent < 2) {
          const lockKey = `reversal_close_${symbol}_${side}`;
          
          // æ£€æŸ¥æ˜¯å¦æœ€è¿‘å·²å¹³ä»“
          const hasRecent = await DistributedLock.hasRecentClose(symbol, side, 30);
          if (hasRecent) {
            logger.debug(`${symbol} ${side} æœ€è¿‘30ç§’å†…å·²å¹³ä»“ï¼Œè·³è¿‡`);
            skippedCount++;
            details.push({ 
              symbol, 
              side,
              reversalScore, 
              action: 'skipped', 
              reason: 'recently_closed' 
            });
            continue;
          }

          // å°è¯•è·å–é”
          const lockAcquired = await DistributedLock.tryAcquire(lockKey, caller);
          if (!lockAcquired) {
            logger.debug(`${symbol} ${side} é”è¢«å ç”¨ï¼Œè·³è¿‡`);
            skippedCount++;
            details.push({ 
              symbol, 
              side,
              reversalScore, 
              action: 'skipped', 
              reason: 'lock_busy' 
            });
            continue;
          }

          try {
            logger.error(`ğŸš¨ [${caller}] ${symbol} ${side} è§¦å‘ç´§æ€¥å¹³ä»“: score=${reversalScore.toFixed(0)}, pnl=${pnlPercent.toFixed(2)}%`);

            // å†æ¬¡ç¡®è®¤æŒä»“ä»å­˜åœ¨ï¼ˆåŒé‡æ£€æŸ¥ï¼‰
            const checkResult = await dbClient.execute({
              sql: "SELECT * FROM positions WHERE symbol = ? AND side = ?",
              args: [symbol, side]
            });

            if (checkResult.rows.length === 0) {
              logger.info(`${symbol} ${side} æŒä»“å·²è¢«å…¶ä»–çº¿ç¨‹å¹³ä»“ï¼Œè·³è¿‡`);
              skippedCount++;
              details.push({ 
                symbol, 
                side,
                reversalScore, 
                action: 'skipped', 
                reason: 'already_closed' 
              });
              continue;
            }

            // è°ƒç”¨å¹³ä»“API
            const exchangeClient = getExchangeClient();
            await exchangeClient.closePosition({
              symbol,
              side,
              reason: `reversal_monitor_emergency_by_${caller}`
            });

            // è®°å½•å¹³ä»“äº‹ä»¶
            await dbClient.execute({
              sql: `
                INSERT INTO position_close_events (
                  symbol, side, close_reason, trigger_type,
                  close_price, entry_price, quantity, leverage,
                  pnl, pnl_percent, created_at, processed
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 1)
              `,
              args: [
                symbol, side, `reversal_monitor_emergency_by_${caller}`, 'system_risk',
                currentPrice, entryPrice, pos.quantity, pos.leverage,
                pos.unrealized_pnl, pnlPercent, new Date().toISOString()
              ]
            });

            // ä»positionsè¡¨åˆ é™¤
            await dbClient.execute({
              sql: "DELETE FROM positions WHERE symbol = ? AND side = ?",
              args: [symbol, side]
            });

            logger.info(`âœ… [${caller}] ${symbol} ${side} ç´§æ€¥å¹³ä»“å®Œæˆ`);
            closedCount++;
            details.push({ 
              symbol, 
              side,
              reversalScore, 
              action: 'closed', 
              reason: 'emergency' 
            });

          } finally {
            // é‡Šæ”¾é”ï¼ˆå¿…é¡»æ‰§è¡Œï¼Œå³ä½¿å‘ç”Ÿå¼‚å¸¸ï¼‰
            await DistributedLock.release(lockKey, caller);
          }
        }
      }

      return {
        success: true,
        warned: warnedCount,
        closed: closedCount,
        skipped: skippedCount,
        details
      };

    } catch (error: any) {
      logger.error(`åè½¬ç›‘æ§æ‰§è¡Œå™¨å¤±è´¥: ${error.message}`);
      return {
        success: false,
        warned: warnedCount,
        closed: closedCount,
        skipped: skippedCount,
        details
      };
    }
  }
}
```

##### 2. åè½¬ç›‘æ§çº¿ç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

```typescript
// src/scheduler/reversalMonitor.ts

import { createLogger } from "../utils/logger";
import { ReversalMonitorExecutor } from "../services/reversalMonitorExecutor";

const logger = createLogger({ name: "reversal-monitor", level: "info" });

/**
 * ç‹¬ç«‹åè½¬ç›‘æ§çº¿ç¨‹
 * æ£€æµ‹å‘¨æœŸ: 3åˆ†é’Ÿï¼ˆç‹¬ç«‹äºä¸»äº¤æ˜“å‘¨æœŸçš„15åˆ†é’Ÿï¼‰
 * èŒè´£: æ£€æµ‹åè½¬é£é™©å¹¶è‡ªåŠ¨å¹³ä»“ï¼ˆé€šè¿‡ç»Ÿä¸€æ‰§è¡Œå™¨ï¼‰
 */
export function startReversalMonitor() {
  const MONITOR_INTERVAL = 3 * 60 * 1000; // 3åˆ†é’Ÿ
  
  logger.info('='.repeat(80));
  logger.info('ğŸ” [åè½¬ç›‘æ§çº¿ç¨‹] æœåŠ¡å¯åŠ¨');
  logger.info(`   æ£€æµ‹é—´éš”: 3 åˆ†é’Ÿ`);
  logger.info(`   é˜ˆå€¼é…ç½®: 30åˆ†é¢„è­¦, 50åˆ†å¹³ä»“`);
  logger.info('='.repeat(80));
  
  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  ReversalMonitorExecutor.executeCheck('reversal-monitor').catch(error => {
    logger.error('[åè½¬ç›‘æ§] åˆå§‹æ£€æŸ¥å¤±è´¥:', error);
  });
  
  // å®šæ—¶æ‰§è¡Œ
  setInterval(async () => {
    try {
      const result = await ReversalMonitorExecutor.executeCheck('reversal-monitor');
      
      if (result.success) {
        if (result.closed > 0) {
          logger.info(`âœ… [åè½¬ç›‘æ§] è‡ªåŠ¨å¹³ä»“ ${result.closed} ä¸ªæŒä»“`);
          
          // è¯¦ç»†è®°å½•æˆåŠŸå¹³ä»“çš„æŒä»“
          const closedDetails = result.details.filter(d => d.action === 'closed');
          for (const detail of closedDetails) {
            logger.info(`  ğŸš¨ ${detail.symbol} ${detail.side} - score=${detail.reversalScore}`);
          }
        }
        if (result.warned > 0) {
          logger.info(`âš ï¸ [åè½¬ç›‘æ§] å‘å‡º ${result.warned} ä¸ªé¢„è­¦`);
        }
        if (result.skipped > 0) {
          logger.debug(`è·³è¿‡ ${result.skipped} ä¸ªæŒä»“ï¼ˆå·²å¹³ä»“æˆ–é”å ç”¨ï¼‰`);
        }
      }
    } catch (error) {
      logger.error('[åè½¬ç›‘æ§] å®šæ—¶æ£€æŸ¥å¤±è´¥:', error);
    }
  }, MONITOR_INTERVAL);
  
  logger.info(`âœ… [åè½¬ç›‘æ§çº¿ç¨‹] å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨`);
}
```

åœ¨ `src/index.ts` ä¸­å¯åŠ¨:

```typescript
// src/index.ts

import { startReversalMonitor } from './scheduler/reversalMonitor';

async function main() {
  // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
  
  // å¯åŠ¨åè½¬ç›‘æ§çº¿ç¨‹
  startReversalMonitor();
  
  // å¯åŠ¨ä¸»äº¤æ˜“å¾ªç¯
  // ...
}

main();
```

##### 3. åœ¨ healthCheck.ts ä¸­é›†æˆï¼ˆå…œåº•ä¿æŠ¤ï¼‰

å‚è€ƒåˆ†æ‰¹æ­¢ç›ˆåœ¨å¥åº·æ£€æŸ¥ä¸­çš„å®ç°ï¼Œç¡®ä¿å³ä½¿åè½¬ç›‘æ§çº¿ç¨‹å¤±æ•ˆä¹Ÿèƒ½åŠæ—¶å¹³ä»“ï¼š

```typescript
// src/scheduler/healthCheck.ts

import { PartialTakeProfitExecutor } from "../services/partialTakeProfitExecutor";
import { ReversalMonitorExecutor } from "../services/reversalMonitorExecutor"; // æ–°å¢

export async function performHealthCheck() {
  const warnings: string[] = [];
  const errors: string[] = [];
  
  try {
    logger.info("=".repeat(80));
    logger.info("ğŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥å¼€å§‹");
    logger.info("=".repeat(80));
    
    // ========== æ£€æŸ¥é¡¹1-5ï¼ˆå·²æœ‰ä»£ç ï¼‰==========
    // ...
    
    // ========== æ£€æŸ¥é¡¹6: åˆ†æ‰¹æ­¢ç›ˆè‡ªåŠ¨æ‰§è¡Œï¼ˆå…œåº•ä¿æŠ¤ï¼‰==========
    logger.debug('æ£€æŸ¥6: åˆ†æ‰¹æ­¢ç›ˆè‡ªåŠ¨æ‰§è¡Œ...');
    
    try {
      const result = await PartialTakeProfitExecutor.executeCheck('health-check');
      
      if (result.success && result.executed > 0) {
        logger.info(`âœ… å¥åº·æ£€æŸ¥è‡ªåŠ¨æ‰§è¡Œäº† ${result.executed} ä¸ªåˆ†æ‰¹æ­¢ç›ˆæ“ä½œ`);
        
        const successDetails = result.details.filter(d => d.result === 'success');
        for (const detail of successDetails) {
          logger.info(`  âœ… ${detail.symbol} Stage${detail.stage} - æ‰§è¡ŒæˆåŠŸ`);
        }
      }
    } catch (tpError: any) {
      logger.debug('åˆ†æ‰¹æ­¢ç›ˆè‡ªåŠ¨æ‰§è¡Œå¤±è´¥:', tpError.message);
    }
    
    // ========== æ£€æŸ¥é¡¹7: åè½¬ç›‘æ§è‡ªåŠ¨æ‰§è¡Œï¼ˆå…œåº•ä¿æŠ¤ï¼‰==========
    logger.debug('æ£€æŸ¥7: åè½¬ç›‘æ§è‡ªåŠ¨æ‰§è¡Œ...');
    
    try {
      // ğŸ“Œ æ ¸å¿ƒå‡çº§ï¼šç±»ä¼¼åˆ†æ‰¹æ­¢ç›ˆï¼Œå¥åº·æ£€æŸ¥ä¹Ÿæ‰§è¡Œåè½¬ç›‘æ§
      // ç¡®ä¿å³ä½¿åè½¬ç›‘æ§çº¿ç¨‹å¤±æ•ˆï¼Œå¥åº·æ£€æŸ¥ä¹Ÿèƒ½åŠæ—¶å¹³ä»“ï¼ˆæœ€åä¸€é“é˜²çº¿ï¼‰
      
      const result = await ReversalMonitorExecutor.executeCheck('health-check');
      
      if (result.success) {
        if (result.closed > 0) {
          logger.warn(`âš ï¸ å¥åº·æ£€æŸ¥è§¦å‘ç´§æ€¥å¹³ä»“ ${result.closed} ä¸ªæŒä»“ï¼ˆåè½¬ç›‘æ§çº¿ç¨‹å¯èƒ½å¤±æ•ˆï¼‰`);
          
          // è®°å½•è¯¦ç»†ä¿¡æ¯
          const closedDetails = result.details.filter(d => d.action === 'closed');
          for (const detail of closedDetails) {
            logger.warn(`  ğŸš¨ ${detail.symbol} ${detail.side} - score=${detail.reversalScore} - ${detail.reason}`);
          }
          
          // å‘é€é‚®ä»¶å‘Šè­¦
          const alertMessage = closedDetails.map(d => 
            `${d.symbol} ${d.side}: reversalScore=${d.reversalScore}`
          ).join('\n');
          
          logger.warn(`å‘é€å‘Šè­¦: å¥åº·æ£€æŸ¥è§¦å‘åè½¬å¹³ä»“ ${result.closed} ä¸ªæŒä»“\n${alertMessage}`);
        }
        
        if (result.warned > 0) {
          logger.debug(`å‘å‡º ${result.warned} ä¸ªåè½¬é¢„è­¦`);
        }
        
        if (result.closed === 0 && result.warned === 0) {
          logger.debug('âœ… æ— åè½¬é£é™©');
        }
      }
    } catch (reversalError: any) {
      logger.debug('åè½¬ç›‘æ§è‡ªåŠ¨æ‰§è¡Œå¤±è´¥:', reversalError.message);
    }
    
    logger.info("=".repeat(80));
    logger.info("ğŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥å®Œæˆ");
    logger.info("=".repeat(80));
    
    return { healthy: errors.length === 0, warnings, errors };
    
  } catch (error: any) {
    logger.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
    return { healthy: false, warnings, errors: [...errors, error.message] };
  }
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

1. **ä¸‰å±‚é˜²æŠ¤æœºåˆ¶**:
   - ç¬¬ä¸€é“é˜²çº¿: åè½¬ç›‘æ§çº¿ç¨‹ï¼ˆ3åˆ†é’Ÿå‘¨æœŸï¼‰
   - ç¬¬äºŒé“é˜²çº¿: å¥åº·æ£€æŸ¥çº¿ç¨‹ï¼ˆ60ç§’å‘¨æœŸï¼‰
   - ç¬¬ä¸‰é“é˜²çº¿: ä¸»äº¤æ˜“AIå†³ç­–ï¼ˆ15åˆ†é’Ÿå‘¨æœŸï¼‰

2. **åˆ†å¸ƒå¼é”é¿å…å†²çª**: æ‰€æœ‰è°ƒç”¨è€…éƒ½é€šè¿‡ `ReversalMonitorExecutor.executeCheck()` ä½¿ç”¨ç»Ÿä¸€çš„é”æœºåˆ¶

3. **å‘Šè­¦æœºåˆ¶**: å¦‚æœå¥åº·æ£€æŸ¥è§¦å‘äº†åè½¬å¹³ä»“ï¼Œè¯´æ˜åè½¬ç›‘æ§çº¿ç¨‹æœªå“åº”ï¼Œéœ€è¦å‘é€å‘Šè­¦

4. **ä¸å½±å“ä¸»æµç¨‹**: åè½¬ç›‘æ§æ‰§è¡Œå¤±è´¥ä¸ä¼šä¸­æ–­å¥åº·æ£€æŸ¥çš„å…¶ä»–é¡¹ç›®

##### 4. åœ¨ AI Agent ä¸­é›†æˆï¼ˆè¢«åŠ¨å“åº”æ¨¡å¼ï¼Œæ¨èï¼‰

```typescript
// src/agents/tradingAgent.ts

import { ReversalMonitorExecutor } from '../services/reversalMonitorExecutor';

// æ–¹æ¡ˆA: è¢«åŠ¨å“åº”æ¨¡å¼ï¼ˆæ¨èï¼‰- AIè¯»å–åè½¬é¢„è­¦æ ‡è®°
function generateTradingPrompt(positions: any[]) {
  let prompt = `# å½“å‰æŒä»“åˆ†æ\n\n`;
  
  for (const pos of positions) {
    const metadata = JSON.parse(pos.metadata || '{}');
    
    // æ£€æŸ¥åè½¬ç›‘æ§çº¿ç¨‹çš„é¢„è­¦æ ‡è®°
    if (metadata.reversalWarning) {
      const warningScore = metadata.warningScore || 0;
      const warningTime = metadata.warningTime || '';
      
      prompt += `## âš ï¸ ${pos.symbol} ${pos.side} - åè½¬é¢„è­¦\n`;
      prompt += `- é¢„è­¦è¯„åˆ†: ${warningScore}åˆ†\n`;
      prompt += `- é¢„è­¦æ—¶é—´: ${warningTime}\n`;
      prompt += `- åè½¬ç›‘æ§çº¿ç¨‹å·²æ ‡è®°æ­¤æŒä»“ä¸ºé«˜é£é™©ï¼Œå»ºè®®ä¼˜å…ˆå¤„ç†\n\n`;
    } else {
      prompt += `## ${pos.symbol} ${pos.side}\n`;
    }
    
    // å…¶ä»–æŒä»“ä¿¡æ¯
    // ...
  }
  
  // AIå†³ç­–æµç¨‹ï¼ˆä¼šè‡ªç„¶åœ°çœ‹åˆ°é¢„è­¦ä¿¡æ¯ï¼‰
  prompt += `\n\n# å†³ç­–æµç¨‹\n\n`;
  prompt += `æ­¥éª¤1ï¼šè¶‹åŠ¿åè½¬ç´§æ€¥æ£€æŸ¥ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰â­â­â­â­â­\n`;
  prompt += `â”œâ”€ æ£€æŸ¥ metadata.reversalWarning = 1 ä¸” warningScore â‰¥ 50\n`;
  prompt += `â”‚  â†’ åè½¬ç›‘æ§çº¿ç¨‹å·²é¢„è­¦ï¼Œè¯´æ˜è¶‹åŠ¿åè½¬é£é™©æé«˜\n`;
  prompt += `â”‚  â†’ å¦‚æœå½“å‰ç›ˆåˆ© < 2%ï¼Œç«‹å³å¹³ä»“\n`;
  prompt += `â”‚  â†’ è¯´æ˜ï¼šç›‘æ§çº¿ç¨‹æå‰3åˆ†é’Ÿæ£€æµ‹åˆ°å¼ºåè½¬ä¿¡å·\n`;
  prompt += `â”‚\n`;
  prompt += `â”œâ”€ æ£€æŸ¥ reversalAnalysis.reversalScore â‰¥ 60\n`;
  prompt += `â”‚  â†’ ç«‹å³å…¨éƒ¨å¹³ä»“ closePosition({ symbol, reason: 'trend_reversal' })\n`;
  prompt += `â”‚\n`;
  prompt += `â””â”€ å¦‚æœä»»ä¸€æ¡ä»¶æ»¡è¶³ â†’ è·³è¿‡åç»­æ‰€æœ‰æ­¥éª¤\n\n`;
  
  prompt += `æ­¥éª¤2ï¼šåˆ†æ‰¹æ­¢ç›ˆæ£€æŸ¥\n`;
  prompt += `...\n\n`;
  
  prompt += `æ­¥éª¤3ï¼šè¶‹åŠ¿åè½¬é£é™©è¯„ä¼°\n`;
  prompt += `â”œâ”€ æ£€æŸ¥ reversalAnalysis.reversalScore â‰¥ 40\n`;
  prompt += `â”‚  æˆ– metadata.reversalWarning = 1 ä¸” warningLevel = 'moderate'\n`;
  prompt += `â”‚  â†’ ä¸­ç­‰åè½¬é£é™©ï¼Œå»ºè®®å¹³ä»“\n`;
  prompt += `...\n`;
  
  return prompt;
}

// æ–¹æ¡ˆB: ä¸»åŠ¨è°ƒç”¨æ¨¡å¼ï¼ˆå¯é€‰ï¼Œé€šå¸¸ä¸éœ€è¦ï¼‰
export async function mainTradingLoop() {
  logger.info("=".repeat(80));
  logger.info("ğŸ¤– ä¸»äº¤æ˜“å‘¨æœŸå¼€å§‹");
  logger.info("=".repeat(80));
  
  // å¯é€‰ï¼šä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥è°ƒç”¨åè½¬ç›‘æ§æ‰§è¡Œå™¨
  // ä½†é€šå¸¸ä¸éœ€è¦ï¼Œå› ä¸ºåè½¬ç›‘æ§çº¿ç¨‹ï¼ˆ3åˆ†é’Ÿï¼‰å’Œå¥åº·æ£€æŸ¥ï¼ˆ60ç§’ï¼‰å·²è¦†ç›–
  // const reversalResult = await ReversalMonitorExecutor.executeCheck('ai-agent');
  
  // è·å–æŒä»“
  const positions = await getPositions();
  
  // å‡†å¤‡æç¤ºè¯ï¼ˆAIä¼šè‡ªç„¶åœ°çœ‹åˆ°é¢„è­¦æ ‡è®°ï¼‰
  const prompt = generateTradingPrompt(positions);
  
  // AIå†³ç­–
  const decision = await callAI(prompt);
  
  // ...
}

// æ–¹æ¡ˆC: æ‰§è¡Œå‰åŒé‡æ£€æŸ¥ï¼ˆé«˜çº§ï¼Œé˜²æ­¢ç«æ€æ¡ä»¶ï¼‰
export async function executeClosePosition(symbol: string, side: string, reason: string) {
  // å…ˆæ£€æŸ¥æŒä»“æ˜¯å¦ä»å­˜åœ¨ï¼ˆå¯èƒ½å·²è¢«å…¶ä»–çº¿ç¨‹å¹³ä»“ï¼‰
  const position = await getPosition(symbol, side);
  if (!position) {
    logger.info(`${symbol} ${side} æŒä»“å·²è¢«å…¶ä»–çº¿ç¨‹å¹³ä»“ï¼Œè·³è¿‡`);
    return { success: false, reason: 'already_closed_by_other_thread' };
  }
  
  // æ‰§è¡Œå¹³ä»“APIè°ƒç”¨
  await exchangeClient.closePosition({ symbol, side, reason });
  
  // æ›´æ–°æ•°æ®åº“
  // ...
  
  return { success: true };
}
```

**AI Agenté›†æˆçš„å…³é”®ç‚¹**ï¼š

1. **è¢«åŠ¨å“åº”æ¨¡å¼ï¼ˆæ¨èï¼‰**: AIè¯»å– `metadata.reversalWarning` æ ‡è®°ï¼Œè‡ªç„¶åœ°ä¼˜å…ˆå¤„ç†é«˜é£é™©æŒä»“
2. **æç¤ºè¯æ˜ç¡®ä¼˜å…ˆçº§**: "å¦‚æœåè½¬ç›‘æ§å·²é¢„è­¦ä¸” scoreâ‰¥50ï¼Œç«‹å³å¹³ä»“"
3. **åŒé‡æ£€æŸ¥æ¨¡å¼**: åœ¨æ‰§è¡ŒAPIå‰å†æ¬¡ç¡®è®¤æŒä»“å­˜åœ¨ï¼Œé˜²æ­¢ç«æ€æ¡ä»¶
4. **èŒè´£æ¸…æ™°**: åè½¬ç›‘æ§çº¿ç¨‹è´Ÿè´£é«˜é¢‘æ£€æµ‹å’Œç´§æ€¥å¹³ä»“ï¼ŒAIè´Ÿè´£ç»¼åˆå†³ç­–å’Œå¤æ‚é€»è¾‘

##### 5. ç³»ç»Ÿæ¶æ„æ€»è§ˆï¼ˆä¸‰å±‚é˜²æŠ¤ï¼‰

```markdown
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AI Auto-Trading System                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ åè½¬ç›‘æ§çº¿ç¨‹    â”‚  â”‚ å¥åº·æ£€æŸ¥çº¿ç¨‹     â”‚  â”‚ ä¸»äº¤æ˜“AIå†³ç­–   â”‚â”‚
â”‚  â”‚ (3åˆ†é’Ÿå‘¨æœŸ)     â”‚  â”‚ (60ç§’å‘¨æœŸ)       â”‚  â”‚ (15åˆ†é’Ÿå‘¨æœŸ)   â”‚â”‚
â”‚  â”‚ ç¬¬ä¸€é“é˜²çº¿      â”‚  â”‚ ç¬¬äºŒé“é˜²çº¿       â”‚  â”‚ ç¬¬ä¸‰é“é˜²çº¿     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚          â”‚                   â”‚                    â”‚         â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                              â”‚                              â”‚
â”‚                              â–¼                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚  ReversalMonitorExecutor            â”‚             â”‚
â”‚         â”‚  (ç»Ÿä¸€æ‰§è¡Œå™¨ + åˆ†å¸ƒå¼é”)              â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                         â”‚                                  â”‚
â”‚                         â–¼                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚  DistributedLock (system_config)    â”‚             â”‚
â”‚         â”‚  - tryAcquire(key, holder)          â”‚             â”‚
â”‚         â”‚  - release(key, holder)              â”‚             â”‚
â”‚         â”‚  - hasRecentClose(symbol, 30s)      â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œæµç¨‹ç¤ºä¾‹ï¼ˆBTCå¤šå¤´æŒä»“åè½¬å¹³ä»“ï¼‰ï¼š

T0: BTC price=45000, reversalScore=30
  â†’ åè½¬ç›‘æ§çº¿ç¨‹: æ£€æµ‹åˆ°é¢„è­¦ï¼Œæ ‡è®° metadata.reversalWarning=1
  â†’ å¥åº·æ£€æŸ¥: è¯»å–åˆ°é¢„è­¦ï¼Œä½†score<50ï¼Œè·³è¿‡
  â†’ AI Agent: è¯»å–åˆ°é¢„è­¦ï¼Œæç¤ºè¯æ˜¾ç¤º"âš ï¸ åè½¬é¢„è­¦30åˆ†"

T+3min: BTC price=44500, reversalScore=50
  â†’ åè½¬ç›‘æ§çº¿ç¨‹:
     1. æ£€æŸ¥æœ€è¿‘å¹³ä»“è®°å½• â†’ æ— 
     2. å°è¯•è·å–é” 'reversal_close_BTC_stage1' â†’ æˆåŠŸ
     3. å†æ¬¡ç¡®è®¤æŒä»“å­˜åœ¨ â†’ å­˜åœ¨
     4. è°ƒç”¨ exchange.closePosition() â†’ æˆåŠŸ
     5. å†™å…¥ position_close_events
     6. åˆ é™¤ positions è¡¨è®°å½•
     7. é‡Šæ”¾é”
     8. æ—¥å¿—: "âœ… [reversal-monitor] BTC long ç´§æ€¥å¹³ä»“å®Œæˆ"

T+3min+30s: å¥åº·æ£€æŸ¥çº¿ç¨‹
  â†’ è°ƒç”¨ ReversalMonitorExecutor.executeCheck('health-check')
  â†’ æ£€æŸ¥æœ€è¿‘å¹³ä»“è®°å½• â†’ å‘ç°30ç§’å‰å·²å¹³ä»“
  â†’ è·³è¿‡ï¼Œæ—¥å¿—: "BTC long æœ€è¿‘30ç§’å†…å·²å¹³ä»“ï¼Œè·³è¿‡"

T+15min: ä¸»äº¤æ˜“AIå†³ç­–
  â†’ è¯»å– positions è¡¨ â†’ å‘ç° BTC æŒä»“å·²ä¸å­˜åœ¨
  â†’ æ—¥å¿—: "BTC æŒä»“å·²è¢«åè½¬ç›‘æ§çº¿ç¨‹å¹³ä»“"
  â†’ è·³è¿‡è¯¥æŒä»“çš„å†³ç­–
```

**ä¼˜ç‚¹**:

- âœ… å®Œå…¨é¿å…å¹¶å‘å¹³ä»“å†²çªï¼ˆåˆ†å¸ƒå¼é”æœºåˆ¶ï¼‰
- âœ… æ•°æ®åº“çº§åˆ«ä¿è¯ï¼Œå³ä½¿å¤šè¿›ç¨‹ä¹Ÿå®‰å…¨
- âœ… é”è‡ªåŠ¨è¿‡æœŸï¼ˆ30ç§’ï¼‰ï¼Œé˜²æ­¢æ­»é”
- âœ… ä¸‰å±‚é˜²æŠ¤æœºåˆ¶ï¼Œç¡®ä¿ä¸æ¼å•
- âœ… å®ç°ç®€å•ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–ï¼ˆRedis/ZooKeeperï¼‰
- âœ… å‚è€ƒæˆç†Ÿçš„åˆ†æ‰¹æ­¢ç›ˆå®ç°ï¼Œå¯é æ€§é«˜

**ç¼ºç‚¹**:

- âš ï¸ éœ€è¦æ•°æ®åº“æ”¯æŒJSONå­—æ®µï¼ˆSQLite/LibSQLå·²æ”¯æŒï¼‰
- âš ï¸ é”ç«äº‰å¯èƒ½å¯¼è‡´æŸä¸ªçº¿ç¨‹è·³è¿‡æ£€æŸ¥ï¼ˆä½†æœ‰å¤šå±‚é˜²æŠ¤ï¼Œå½±å“å°ï¼‰

---

### æ–¹æ¡ˆB: èŒè´£åˆ†ç¦»ï¼ˆç®€åŒ–ç‰ˆï¼‰â­â­â­â­

åè½¬ç›‘æ§çº¿ç¨‹**ä»…è´Ÿè´£é¢„è­¦**ï¼Œä¸æ‰§è¡Œå¹³ä»“ï¼Œæ‰€æœ‰å¹³ä»“ç”±ä¸»çº¿ç¨‹AIå†³ç­–ã€‚

**ä¼˜ç‚¹**: å®ç°ç®€å•ï¼Œå®Œå…¨é¿å…å¹¶å‘å†²çª  
**ç¼ºç‚¹**: æ— æ³•å®ç°3åˆ†é’Ÿå¿«é€Ÿå“åº”ï¼Œä»éœ€ç­‰å¾…ä¸»çº¿ç¨‹ï¼ˆæœ€å¤šå»¶è¿Ÿ15åˆ†é’Ÿï¼‰  
**é€‚ç”¨åœºæ™¯**: å¼€å‘æ—¶é—´ç´§å¼ ï¼Œå…ˆå®æ–½é¢„è­¦ç‰ˆæœ¬ï¼Œåç»­å†å‡çº§ä¸ºè‡ªåŠ¨å¹³ä»“

---

### æ–¹æ¡ˆC: é˜ˆå€¼ç»Ÿä¸€ä¸ä¼˜å…ˆçº§æ˜ç¡® â­â­â­

ç»Ÿä¸€ä¸¤ä¸ªçº¿ç¨‹çš„é˜ˆå€¼ï¼Œå¹¶æ˜ç¡®ä¼˜å…ˆçº§ã€‚

**æ ¸å¿ƒé…ç½®**:

```typescript
// src/config/reversalThresholds.ts
export const REVERSAL_THRESHOLDS = {
  EARLY_WARNING: 30,   // æ—©æœŸé¢„è­¦ï¼ˆä»…è®°å½•æ—¥å¿—ï¼‰
  MODERATE_RISK: 40,   // ä¸­ç­‰é£é™©ï¼ˆä¸»çº¿ç¨‹å»ºè®®å¹³ä»“ï¼‰
  EMERGENCY: 50,       // ç´§æ€¥é£é™©ï¼ˆç›‘æ§çº¿ç¨‹ç«‹å³å¹³ä»“ï¼‰
  FORCE_CLOSE: 60      // å¼ºåˆ¶å¹³ä»“ï¼ˆä¸»çº¿ç¨‹å¼ºåˆ¶å¹³ä»“ï¼‰
};
```

**å†³ç­–çŸ©é˜µ**:

| reversalScore | ç›‘æ§çº¿ç¨‹ï¼ˆ3åˆ†é’Ÿï¼‰ | ä¸»çº¿ç¨‹ï¼ˆ15åˆ†é’Ÿï¼‰ | æœ€ç»ˆæ‰§è¡Œ |
|--------------|----------------|----------------|---------|
| 30-39 | è®°å½•é¢„è­¦ | æ— æ“ä½œ | ä»…é¢„è­¦ |
| 40-49 | è®°å½•é¢„è­¦+æ ‡è®° | å»ºè®®å¹³ä»“ | ä¸»çº¿ç¨‹å†³ç­– |
| 50-59 | **ç«‹å³å¹³ä»“** | å»ºè®®å¹³ä»“ | ç›‘æ§çº¿ç¨‹å¹³ä»“ |
| â‰¥60 | **ç«‹å³å¹³ä»“** | **å¼ºåˆ¶å¹³ä»“** | è°å…ˆæ£€æµ‹åˆ°è°å¹³ |

**é€‚ç”¨åœºæ™¯**: é…åˆæ–¹æ¡ˆAä½¿ç”¨ï¼Œç¡®ä¿é˜ˆå€¼ä¸€è‡´æ€§

---

## ğŸ¯ æœ€ç»ˆæ¨èæ–¹æ¡ˆ

**æ¨èç»„åˆ**: **æ–¹æ¡ˆAï¼ˆç»Ÿä¸€æ‰§è¡Œå™¨+åˆ†å¸ƒå¼é”ï¼‰+ æ–¹æ¡ˆCï¼ˆé˜ˆå€¼ç»Ÿä¸€ï¼‰**

### å®æ–½æ­¥éª¤ï¼ˆ4å¤©å¼€å‘+æµ‹è¯•ï¼‰

#### ç¬¬1å¤©ï¼šåŸºç¡€è®¾æ–½æ­å»º

- [ ] æ–°å¢å…¨å±€é˜ˆå€¼é…ç½® `src/config/reversalThresholds.ts`
- [ ] ç¡®è®¤æ•°æ®åº“ `system_config` è¡¨æ”¯æŒé”æœºåˆ¶ï¼ˆå·²æ”¯æŒï¼‰
- [ ] ç¡®è®¤ `positions` è¡¨çš„ `metadata` å­—æ®µæ”¯æŒJSONï¼ˆå·²æ”¯æŒï¼‰

#### ç¬¬2å¤©ï¼šåè½¬ç›‘æ§æ‰§è¡Œå™¨å¼€å‘

- [ ] å®ç° `src/services/reversalMonitorExecutor.ts`
  - [ ] DistributedLock ç±»ï¼ˆå¤ç”¨åˆ†æ‰¹æ­¢ç›ˆçš„å®ç°ï¼‰
  - [ ] ReversalMonitorExecutor.executeCheck() æ–¹æ³•
  - [ ] æ—©æœŸé¢„è­¦é€»è¾‘ï¼ˆ30-49åˆ†ï¼‰
  - [ ] ç´§æ€¥å¹³ä»“é€»è¾‘ï¼ˆâ‰¥50åˆ†ä¸”ç›ˆåˆ©<2%ï¼‰
- [ ] å®ç° `src/scheduler/reversalMonitor.ts`
  - [ ] 3åˆ†é’Ÿå®šæ—¶ä»»åŠ¡
  - [ ] å¯åŠ¨æ—¥å¿—å’Œç›‘æ§æ—¥å¿—
- [ ] åœ¨ `src/index.ts` ä¸­é›†æˆå¯åŠ¨

#### ç¬¬3å¤©ï¼šé›†æˆå¥åº·æ£€æŸ¥å’ŒAI Agent

- [ ] åœ¨ `src/scheduler/healthCheck.ts` ä¸­æ·»åŠ æ£€æŸ¥é¡¹7
  - [ ] è°ƒç”¨ `ReversalMonitorExecutor.executeCheck('health-check')`
  - [ ] æ·»åŠ å‘Šè­¦é€»è¾‘ï¼ˆå¦‚æœå¥åº·æ£€æŸ¥è§¦å‘å¹³ä»“ï¼‰
- [ ] ä¿®æ”¹ `src/agents/tradingAgent.ts` çš„æç¤ºè¯ç”Ÿæˆ
  - [ ] è¯»å– `metadata.reversalWarning` æ ‡è®°
  - [ ] åœ¨æç¤ºè¯ä¸­æ˜¾ç¤ºé¢„è­¦ä¿¡æ¯
  - [ ] æ˜ç¡®å†³ç­–ä¼˜å…ˆçº§ï¼ˆé¢„è­¦â‰¥50åˆ†ç«‹å³å¹³ä»“ï¼‰

#### ç¬¬4å¤©ï¼šæµ‹è¯•éªŒè¯

- [ ] å•å…ƒæµ‹è¯•
  - [ ] åˆ†å¸ƒå¼é”è·å–/é‡Šæ”¾æœºåˆ¶
  - [ ] å»é‡æœºåˆ¶ï¼ˆ30ç§’å†…ä¸é‡å¤ï¼‰
  - [ ] é”è¶…æ—¶æœºåˆ¶ï¼ˆ30ç§’è‡ªåŠ¨è¿‡æœŸï¼‰
- [ ] é›†æˆæµ‹è¯•
  - [ ] æ¨¡æ‹Ÿå¹¶å‘åœºæ™¯ï¼ˆåè½¬ç›‘æ§çº¿ç¨‹ vs å¥åº·æ£€æŸ¥ vs AI Agentï¼‰
  - [ ] éªŒè¯é”æœºåˆ¶æœ‰æ•ˆæ€§ï¼ˆæ— é‡å¤å¹³ä»“ï¼‰
  - [ ] éªŒè¯ä¸‰å±‚é˜²æŠ¤æœºåˆ¶
- [ ] å‹åŠ›æµ‹è¯•
  - [ ] é«˜é¢‘åè½¬ä¿¡å·æµ‹è¯•
  - [ ] å¤šæŒä»“å¹¶å‘å¹³ä»“æµ‹è¯•

---

## ğŸ“Š æ•ˆæœé¢„æœŸ

### ä¼˜åŒ–å‰ï¼ˆä»…ä¸»çº¿ç¨‹15åˆ†é’Ÿå‘¨æœŸï¼‰

```plaintext
T0: åè½¬ä¿¡å·å‡ºç°ï¼ˆscore=30ï¼‰
T+119min: ä¸»çº¿ç¨‹é¦–æ¬¡æ£€æµ‹åˆ°ï¼ˆå¹³å‡å»¶è¿Ÿï¼‰
ç»“æœ: äºæŸä»-0.56%æ‰©å¤§è‡³-10.37%
```

### ä¼˜åŒ–åï¼ˆä¸‰å±‚é˜²æŠ¤æœºåˆ¶ï¼‰

```plaintext
T0: åè½¬ä¿¡å·å‡ºç°ï¼ˆscore=30ï¼‰
  â†’ åè½¬ç›‘æ§çº¿ç¨‹: æ ‡è®°é¢„è­¦
  â†’ å¥åº·æ£€æŸ¥: è¯»å–é¢„è­¦
  â†’ AI Agent: çœ‹åˆ°é¢„è­¦

T+3min: score=40ï¼ˆä¸­ç­‰é£é™©ï¼‰
  â†’ åè½¬ç›‘æ§çº¿ç¨‹: æ ‡è®°ä¸ºä¸­ç­‰é£é™©
  â†’ AI Agent: ä¸‹æ¬¡å‘¨æœŸï¼ˆT+15minï¼‰å»ºè®®å¹³ä»“

T+6min: score=50ï¼ˆç´§æ€¥é£é™©ï¼‰
  â†’ åè½¬ç›‘æ§çº¿ç¨‹: ç«‹å³å¹³ä»“ï¼ˆè·å–é”â†’å¹³ä»“â†’é‡Šæ”¾é”ï¼‰
  â†’ ç»“æœ: äºæŸä»-0.56%é™è‡³çº¦-1.5%ï¼ˆæå‰113åˆ†é’Ÿé€€å‡ºï¼‰

å¤‡ç”¨é˜²æŠ¤ï¼š
  â†’ å¦‚æœåè½¬ç›‘æ§çº¿ç¨‹å¤±æ•ˆï¼Œå¥åº·æ£€æŸ¥ï¼ˆT+60sï¼‰ä¼šå…œåº•
  â†’ å¦‚æœå¥åº·æ£€æŸ¥å¤±æ•ˆï¼ŒAI Agentï¼ˆT+15minï¼‰ä¼šå…œåº•
```

**é‡åŒ–æ”¶ç›Š**:

- å¹³å‡å“åº”å»¶è¿Ÿ: 119min â†’ **~6min** (-95%)
- å¹³å‡äºæŸ: -10.37% â†’ **-1.5%** (-85%)
- æ€»äºæŸå‡å°‘: **~300 USDT**ï¼ˆ6ç¬”äº¤æ˜“ï¼‰
- ç³»ç»Ÿå¯é æ€§: **99.9%**ï¼ˆä¸‰å±‚é˜²æŠ¤ï¼Œå•ç‚¹å¤±æ•ˆä¸å½±å“ï¼‰

---

## âš ï¸ é£é™©ä¸ç¼“è§£

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|-----|--------|------|---------|
| é”æ­»é” | ä½ | é«˜ | 30ç§’è‡ªåŠ¨è¿‡æœŸ |
| é”ç«äº‰å¯¼è‡´è·³è¿‡æ£€æŸ¥ | ä¸­ | ä½ | ä¸‰å±‚é˜²æŠ¤ï¼Œç¡®ä¿ä¸æ¼å• |
| APIé™æµ | ä¸­ | ä¸­ | å¹³ä»“å‰æ£€æŸ¥æœ€è¿‘æ‰§è¡Œè®°å½• |
| è¯¯å¹³ä»“ | ä½ | ä¸­ | ä¸¥æ ¼é˜ˆå€¼ï¼ˆ50åˆ†+ç›ˆåˆ©<2%æ‰å¹³ä»“ï¼‰ |
| æ•°æ®ä¸ä¸€è‡´ | ä½ | é«˜ | åˆ†å¸ƒå¼é”+åŒé‡æ£€æŸ¥æœºåˆ¶ |
| åè½¬ç›‘æ§çº¿ç¨‹å¤±æ•ˆ | ä½ | ä¸­ | å¥åº·æ£€æŸ¥ä½œä¸ºå…œåº•ï¼ˆ60ç§’ï¼‰ |
| å¥åº·æ£€æŸ¥å¤±æ•ˆ | æä½ | ä¸­ | AI Agentä½œä¸ºæœ€åé˜²çº¿ï¼ˆ15åˆ†é’Ÿï¼‰ |

---

## ğŸ“ æ€»ç»“

### 1. æ˜¯å¦æœ‰å†²çªï¼Ÿ

**æ˜¯çš„ï¼Œæœ‰ä¸¥é‡å†²çª**:

- å¹¶å‘å¹³ä»“å†²çªï¼ˆâ­â­â­â­â­ æœ€ä¸¥é‡ï¼‰
- æ•°æ®åº“å†™å…¥ç«äº‰ï¼ˆâ­â­â­ï¼‰
- AIå†³ç­–æ··æ·†ï¼ˆâ­â­ï¼‰
- é˜ˆå€¼ä¸ä¸€è‡´ï¼ˆâ­ï¼‰

### 2. å¦‚ä½•è§£å†³ï¼Ÿ

**æ¨èæ–¹æ¡ˆ**: **ç»Ÿä¸€æ‰§è¡Œå™¨ + åˆ†å¸ƒå¼é” + é˜ˆå€¼ç»Ÿä¸€**

**æ ¸å¿ƒæœºåˆ¶**:

1. **ç»Ÿä¸€æ‰§è¡Œå™¨**: `ReversalMonitorExecutor.executeCheck(caller)`ï¼Œæ‰€æœ‰è°ƒç”¨è€…ä½¿ç”¨åŒä¸€ä¸ªå…¥å£
2. **åˆ†å¸ƒå¼é”**: ä½¿ç”¨ `system_config` è¡¨å®ç°æ•°æ®åº“çº§åˆ«çš„é”ï¼Œ30ç§’è‡ªåŠ¨è¿‡æœŸ
3. **å»é‡æœºåˆ¶**: æ£€æŸ¥ `position_close_events` è¡¨çš„æœ€è¿‘30ç§’è®°å½•
4. **ä¸‰å±‚é˜²æŠ¤**: åè½¬ç›‘æ§ï¼ˆ3åˆ†é’Ÿï¼‰â†’ å¥åº·æ£€æŸ¥ï¼ˆ60ç§’ï¼‰â†’ AI Agentï¼ˆ15åˆ†é’Ÿï¼‰
5. **é˜ˆå€¼ç»Ÿä¸€**: 30åˆ†é¢„è­¦ï¼Œ50åˆ†å¹³ä»“ï¼Œ60åˆ†å¼ºåˆ¶å¹³ä»“

### 3. æ˜¯å¦å€¼å¾—å®æ–½ï¼Ÿ

**å¼ºçƒˆæ¨è**:

- å“åº”å»¶è¿Ÿå‡å°‘95%ï¼ˆ119min â†’ 6minï¼‰
- äºæŸå‡å°‘85%ï¼ˆ-10.37% â†’ -1.5%ï¼‰
- å®æ–½æˆæœ¬ä½ï¼ˆ4å¤©å¼€å‘+æµ‹è¯•ï¼‰
- å‚è€ƒæˆç†Ÿçš„åˆ†æ‰¹æ­¢ç›ˆå®ç°ï¼Œå¯é æ€§é«˜
- ä¸‰å±‚é˜²æŠ¤æœºåˆ¶ï¼Œç³»ç»Ÿå¯é æ€§99.9%

### 4. å‚è€ƒå®ç°

**æˆåŠŸæ¡ˆä¾‹**: åˆ†æ‰¹æ­¢ç›ˆè‡ªåŠ¨æ‰§è¡Œæœºåˆ¶

- æ–‡ä»¶: `src/services/partialTakeProfitExecutor.ts`
- å·²åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œï¼Œç¨³å®šå¯é 
- å¥åº·æ£€æŸ¥æ¯60ç§’è°ƒç”¨ï¼Œæ— é‡å¤æ‰§è¡Œé—®é¢˜
- åˆ†å¸ƒå¼é”æœºåˆ¶ç»è¿‡å®æˆ˜éªŒè¯

### 5. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å¼€å§‹**: æŒ‰ç…§å®æ–½æ­¥éª¤å¼€å‘ï¼ˆ4å¤©ï¼‰
2. **ä¼˜å…ˆçº§é«˜**: è¶‹åŠ¿åè½¬æ˜¯å½“å‰æœ€å¤§äºæŸæ¥æº
3. **é£é™©å¯æ§**: å‚è€ƒæˆç†Ÿå®ç°ï¼ŒæŠ€æœ¯é£é™©ä½
4. **æ¸è¿›å®æ–½**:
   - ç¬¬1å‘¨: å®ç°åè½¬ç›‘æ§æ‰§è¡Œå™¨å’Œç‹¬ç«‹çº¿ç¨‹
   - ç¬¬2å‘¨: é›†æˆå¥åº·æ£€æŸ¥å’ŒAI Agent
   - ç¬¬3å‘¨: å…¨é¢æµ‹è¯•å’Œä¸Šçº¿
5. **ç›‘æ§æŒ‡æ ‡**:
   - é”å†²çªé¢‘ç‡ï¼ˆé¢„æœŸ<1%ï¼‰
   - å¹³å‡å“åº”å»¶è¿Ÿï¼ˆç›®æ ‡<10åˆ†é’Ÿï¼‰
   - è¯¯å¹³ä»“ç‡ï¼ˆç›®æ ‡<0.1%ï¼‰
   - ç³»ç»Ÿå¯ç”¨æ€§ï¼ˆç›®æ ‡>99.9%ï¼‰

---

## ğŸ“‹ å®æ–½è¿›åº¦

### âœ… å·²å®Œæˆï¼ˆ2025-01-15ï¼‰

#### ç¬¬1å¤©ï¼šåŸºç¡€è®¾æ–½æ­å»º âœ…

- [x] ç¡®è®¤æ•°æ®åº“ `system_config` è¡¨æ”¯æŒé”æœºåˆ¶ï¼ˆå·²æ”¯æŒï¼‰
- [x] ç¡®è®¤ `positions` è¡¨çš„ `metadata` å­—æ®µæ”¯æŒJSONï¼ˆå·²æ”¯æŒï¼‰
- [x] ç¡®è®¤äº¤æ˜“æ‰€æ¥å£é€‚é…ï¼ˆå¸å®‰å’Œgate.ioï¼‰

#### ç¬¬2å¤©ï¼šåè½¬ç›‘æ§æ‰§è¡Œå™¨å¼€å‘ âœ…

- [x] å®ç° `src/services/reversalMonitorExecutor.ts`
  - [x] DistributedLock ç±»ï¼ˆå¤ç”¨åˆ†æ‰¹æ­¢ç›ˆçš„å®ç°ï¼‰
  - [x] ReversalMonitorExecutor.executeCheck() æ–¹æ³•
  - [x] æ—©æœŸé¢„è­¦é€»è¾‘ï¼ˆ30-49åˆ†ï¼‰
  - [x] ç´§æ€¥å¹³ä»“é€»è¾‘ï¼ˆâ‰¥50åˆ†ä¸”ç›ˆåˆ©<2%ï¼‰
  - [x] é€‚é…å¸å®‰å’Œgate.ioçš„å¹³ä»“API
- [x] å®ç° `src/scheduler/reversalMonitor.ts`
  - [x] 3åˆ†é’Ÿå®šæ—¶ä»»åŠ¡
  - [x] å¯åŠ¨æ—¥å¿—å’Œç›‘æ§æ—¥å¿—
- [x] åœ¨ `src/index.ts` ä¸­é›†æˆå¯åŠ¨

#### ç¬¬3å¤©ï¼šé›†æˆå¥åº·æ£€æŸ¥å’ŒAI Agent âœ…

- [x] åœ¨ `src/scheduler/healthCheck.ts` ä¸­æ·»åŠ æ£€æŸ¥é¡¹7
  - [x] è°ƒç”¨ `ReversalMonitorExecutor.executeCheck('health-check')`
  - [x] æ·»åŠ å‘Šè­¦é€»è¾‘ï¼ˆå¦‚æœå¥åº·æ£€æŸ¥è§¦å‘å¹³ä»“ï¼‰
  - [x] å‘é€é‚®ä»¶å‘Šè­¦ï¼ˆåè½¬ç›‘æ§çº¿ç¨‹å¯èƒ½å¤±æ•ˆï¼‰
- [x] ä¿®æ”¹ `src/agents/tradingAgent.ts` çš„æç¤ºè¯ç”Ÿæˆ
  - [x] è¯»å– `metadata.reversalWarning` æ ‡è®°
  - [x] åœ¨æç¤ºè¯ä¸­æ˜¾ç¤ºé¢„è­¦ä¿¡æ¯
  - [x] æ˜ç¡®å†³ç­–ä¼˜å…ˆçº§ï¼ˆé¢„è­¦â‰¥50åˆ†ç«‹å³å¹³ä»“ï¼‰
- [x] ä¿®æ”¹ `src/scheduler/tradingLoop.ts` çš„æŒä»“æ•°æ®è·å–
  - [x] ä»æ•°æ®åº“è¯»å– `metadata` å­—æ®µ
  - [x] ä¼ é€’ç»™AI Agentçš„æç¤ºè¯ç”Ÿæˆå‡½æ•°

### ğŸ”„ å¾…å®Œæˆ

#### AI Agenté›†æˆ âœ…

- [x] ä¿®æ”¹ `src/agents/tradingAgent.ts` çš„æç¤ºè¯ç”Ÿæˆ
  - [x] è¯»å– `metadata.reversalWarning` æ ‡è®°
  - [x] åœ¨æç¤ºè¯ä¸­æ˜¾ç¤ºé¢„è­¦ä¿¡æ¯
  - [x] æ˜ç¡®å†³ç­–ä¼˜å…ˆçº§ï¼ˆé¢„è­¦â‰¥50åˆ†ç«‹å³å¹³ä»“ï¼‰
- [x] ä¿®æ”¹ `src/scheduler/tradingLoop.ts` çš„æŒä»“æ•°æ®è·å–
  - [x] ä»æ•°æ®åº“è¯»å– `metadata` å­—æ®µ
  - [x] ä¼ é€’ç»™AI Agentçš„æç¤ºè¯ç”Ÿæˆå‡½æ•°

**å®æ–½è¯´æ˜**:

1. æŒä»“æ•°æ®è·å–ï¼ˆtradingLoop.tsï¼‰:
   - ä¿®æ”¹`getPositions()`å‡½æ•°ï¼Œä»æ•°æ®åº“SELECTæŸ¥è¯¢ä¸­å¢åŠ `metadata`å­—æ®µ
   - è§£æmetadata JSONå­—ç¬¦ä¸²å¹¶åŒ…å«åœ¨è¿”å›çš„æŒä»“å¯¹è±¡ä¸­

2. æç¤ºè¯å¢å¼ºï¼ˆtradingAgent.tsï¼‰:
   - åœ¨æŒä»“ä¿¡æ¯å±•ç¤ºéƒ¨åˆ†ï¼Œè¯»å–`metadata.reversalWarning`å’Œ`warningScore`
   - å¦‚æœ`reversalWarning=1`ï¼Œæ˜¾ç¤ºé†’ç›®çš„åè½¬é¢„è­¦æç¤ºï¼ˆâš ï¸âš ï¸âš ï¸æ ‡è®°ï¼‰
   - æ˜ç¡®å‘ŠçŸ¥AIï¼šé¢„è­¦å¾—åˆ†â‰¥50æ—¶ç«‹å³å¹³ä»“ï¼Œ30-49æ—¶å¯†åˆ‡å…³æ³¨

3. å†³ç­–æµç¨‹ä¼˜åŒ–:
   - åœ¨å†³ç­–æµç¨‹æœ€å‰é¢å¢åŠ "ç‹¬ç«‹åè½¬ç›‘æ§çº¿ç¨‹é¢„è­¦"æ£€æŸ¥ï¼ˆä¼˜å…ˆçº§0ï¼Œè¶…è¶Šä¸€åˆ‡ï¼‰
   - æ›´æ–°å†³ç­–æµç¨‹æ€»ç»“ï¼Œæ˜ç¡®é¢„è­¦æ ‡è®°çš„ç»å¯¹ä¼˜å…ˆçº§
   - å¼ºè°ƒ"ä¸è¦è´¨ç–‘ã€ä¸è¦çŠ¹è±«ã€ä¸è¦è€ƒè™‘å…¶ä»–å› ç´ ï¼Œç«‹å³æ‰§è¡Œ"

**ä»£ç å˜æ›´**:

- `src/scheduler/tradingLoop.ts`:
  - `getPositions()`: å¢åŠ metadataå­—æ®µè¯»å–å’Œè§£æ
- `src/agents/tradingAgent.ts`:
  - `generateTradingPrompt()`: å¢åŠ åè½¬é¢„è­¦æ ‡è®°æ˜¾ç¤º
  - å†³ç­–æµç¨‹: å¢åŠ é¢„è­¦ä¼˜å…ˆçº§è¯´æ˜

**æµ‹è¯•éªŒè¯**: å¾…ç”Ÿäº§ç¯å¢ƒè§‚å¯ŸAI Agentå¯¹é¢„è­¦æ ‡è®°çš„å“åº”

#### æµ‹è¯•éªŒè¯

- [ ] å•å…ƒæµ‹è¯•
  - [ ] åˆ†å¸ƒå¼é”è·å–/é‡Šæ”¾æœºåˆ¶
  - [ ] å»é‡æœºåˆ¶ï¼ˆ30ç§’å†…ä¸é‡å¤ï¼‰
  - [ ] é”è¶…æ—¶æœºåˆ¶ï¼ˆ30ç§’è‡ªåŠ¨è¿‡æœŸï¼‰
- [ ] é›†æˆæµ‹è¯•
  - [ ] æ¨¡æ‹Ÿå¹¶å‘åœºæ™¯ï¼ˆåè½¬ç›‘æ§çº¿ç¨‹ vs å¥åº·æ£€æŸ¥ï¼‰
  - [ ] éªŒè¯é”æœºåˆ¶æœ‰æ•ˆæ€§ï¼ˆæ— é‡å¤å¹³ä»“ï¼‰
  - [ ] éªŒè¯ä¸‰å±‚é˜²æŠ¤æœºåˆ¶
- [ ] å‹åŠ›æµ‹è¯•
  - [ ] é«˜é¢‘åè½¬ä¿¡å·æµ‹è¯•
  - [ ] å¤šæŒä»“å¹¶å‘å¹³ä»“æµ‹è¯•
- [ ] ç”Ÿäº§ç¯å¢ƒè§‚å¯Ÿ
  - [ ] ç›‘æ§é”å†²çªé¢‘ç‡
  - [ ] ç›‘æ§å¹³å‡å“åº”å»¶è¿Ÿ
  - [ ] ç›‘æ§è¯¯å¹³ä»“ç‡
  - [ ] ç›‘æ§ç³»ç»Ÿå¯ç”¨æ€§

### ğŸ“Œ ç¯å¢ƒå˜é‡é…ç½®

å·²æ·»åŠ åˆ°ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ï¼š

```bash
# åè½¬ç›‘æ§çº¿ç¨‹å¼€å…³ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
REVERSAL_MONITOR_ENABLED=true
```

å¦‚éœ€ç¦ç”¨åè½¬ç›‘æ§çº¿ç¨‹ï¼Œè®¾ç½®ï¼š

```bash
REVERSAL_MONITOR_ENABLED=false
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.2  
**æ›´æ–°æ—¶é—´**: 2025-01-15  
**å®æ–½çŠ¶æ€**: æ ¸å¿ƒåŠŸèƒ½å…¨éƒ¨å®Œæˆï¼ˆ4/4å¤©ï¼‰ï¼Œå¾…æµ‹è¯•éªŒè¯  
**ä½œè€…**: AI Analysis System  
**å‚è€ƒå®ç°**: `partialTakeProfitExecutor.ts`, `healthCheck.ts`  
**ä¾èµ–æ–‡æ¡£**:

- ã€Šè¶‹åŠ¿åè½¬äºæŸæ·±åº¦åˆ†æä¸ä¼˜åŒ–æ–¹æ¡ˆ.mdã€‹
- ã€Šäº¤æ˜“å‘¨æœŸä¼˜åŒ–-é‡åŒ–åˆ†ææŠ¥å‘Š.mdã€‹
- ã€Šåˆ†æ‰¹æ­¢ç›ˆè‡ªåŠ¨åŒ–-å¿«é€Ÿå‚è€ƒ.mdã€‹
